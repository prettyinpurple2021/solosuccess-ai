# Database Schema Fix Guide

## ðŸš¨ Issue: Missing Templates Tables

The templates feature is failing because the required database tables don't exist in your Supabase database.

**Error:** `Could not find a relationship between 'template_categories' and 'templates'`

## âœ… Solution Steps

### Step 1: Apply Database Migration

You have two options to create the missing tables:

#### Option A: Use Supabase Dashboard (Recommended)

1. **Go to your Supabase Dashboard**
   - Visit: <https://supabase.com/dashboard>
   - Select your SoloBoss project

2. **Navigate to SQL Editor**
   - Click on "SQL Editor" in the left sidebar

3. **Run the Migration**
   - Copy and paste the contents of `supabase/migrations/002_add_templates_schema.sql`
   - Click "Run" to execute the SQL

#### Option B: Use Supabase CLI

If you have Supabase CLI installed:

```bash
# Apply the migration
supabase db push

# Or run the specific migration
supabase migration up
```

### Step 2: Seed the Database

After creating the tables, you need to populate them with template data:

```bash
# Run the templates setup script
npm run setup-templates
```

This will:

- Insert template categories (Founder Systems, Lead Gen & Sales, etc.)
- Insert individual templates (Decision Dashboard, Vision Board, etc.)
- Set up proper relationships between categories and templates

### Step 3: Verify the Fix

1. **Check the build:**

   ```bash
   npm run build
   ```

   - The templates error should be gone

2. **Test the templates feature:**
   - Visit `/templates` in your app
   - The template library should load properly

## ðŸ“‹ What Gets Created

### Tables Created

- `template_categories` - Template categories (Founder Systems, Lead Gen & Sales, etc.)
- `templates` - Individual templates with metadata
- `user_templates` - User's saved template data

### Data Seeded

- **3 Categories:**
  - Founder Systems & Self-Mgmt
  - Lead Gen & Sales  
  - Thinking & Planning Tools

- **10+ Templates:**
  - Decision Dashboard
  - Vision Board Generator
  - Quarterly Biz Review
  - Delegation List Builder
  - 'I Hate This' Tracker
  - Freebie Funnel Builder
  - DM Sales Script Generator
  - Offer Comparison Matrix
  - Live Launch Tracker
  - Upsell Flow Builder

### Security Policies

- Public read access for template categories and templates
- User-specific access for saved template data
- Proper Row Level Security (RLS) enabled

## ðŸ”§ Manual Database Setup (Alternative)

If the automated scripts don't work, you can manually create the tables:

### 1. Create Tables

```sql
-- Create template_categories table
CREATE TABLE IF NOT EXISTS template_categories (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  category TEXT NOT NULL,
  icon TEXT,
  description TEXT
);

-- Create templates table
CREATE TABLE IF NOT EXISTS templates (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT,
  slug TEXT NOT NULL UNIQUE,
  is_interactive BOOLEAN DEFAULT FALSE NOT NULL,
  required_role TEXT NOT NULL,
  category_id BIGINT REFERENCES template_categories(id)
);

-- Create user_templates table
CREATE TABLE IF NOT EXISTS user_templates (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  template_slug TEXT NOT NULL,
  template_data JSONB NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2. Enable RLS

```sql
ALTER TABLE template_categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_templates ENABLE ROW LEVEL SECURITY;
```

### 3. Create Policies

```sql
-- Public read access for categories and templates
CREATE POLICY "Anyone can view template categories" ON template_categories FOR SELECT USING (true);
CREATE POLICY "Anyone can view templates" ON templates FOR SELECT USING (true);

-- User-specific access for saved templates
CREATE POLICY "Users can view their own templates" ON user_templates FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert their own templates" ON user_templates FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own templates" ON user_templates FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete their own templates" ON user_templates FOR DELETE USING (auth.uid() = user_id);
```

### 4. Create Indexes

```sql
CREATE INDEX IF NOT EXISTS idx_templates_slug ON templates(slug);
CREATE INDEX IF NOT EXISTS idx_templates_category_id ON templates(category_id);
CREATE INDEX IF NOT EXISTS idx_user_templates_user_id ON user_templates(user_id);
CREATE INDEX IF NOT EXISTS idx_user_templates_template_slug ON user_templates(template_slug);
```

## ðŸš€ Quick Fix Commands

```bash
# 1. Apply migration (if using Supabase CLI)
supabase db push

# 2. Seed the database
npm run setup-templates

# 3. Test the fix
npm run build
```

## âœ… Verification Checklist

- [ ] Database tables created successfully
- [ ] Template data seeded
- [ ] Build completes without templates error
- [ ] `/templates` page loads properly
- [ ] Template components render correctly

## ðŸ†˜ Troubleshooting

### If tables already exist

The script will skip seeding if data already exists.

### If you get permission errors

Make sure you're using the service role key for admin operations.

### If the relationship error persists

1. Check that both tables exist
2. Verify the foreign key relationship is correct
3. Ensure the migration ran successfully

## ðŸ“ž Need Help?

If you're still having issues:

1. Check the Supabase logs for detailed error messages
2. Verify your environment variables are correct
3. Ensure you have the necessary permissions in Supabase

---

**After completing these steps, the templates feature should work properly!** ðŸŽ‰
