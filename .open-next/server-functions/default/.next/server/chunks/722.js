"use strict";exports.id=722,exports.ids=[722],exports.modules={90722:(a,b,c)=>{c.d(b,{p:()=>h});var d=c(30477),e=c(76685);let f={enableChangeDetection:!0,changeThreshold:.1,notifyOnChange:!0,storeHistory:!0};class g{constructor(a=!0){this.jobQueue=new Map,this.runningJobs=new Set,this.jobHistory=new Map,this.metrics={totalJobs:0,pendingJobs:0,runningJobs:0,completedJobs:0,failedJobs:0,averageExecutionTime:0,successRate:0},this.isRunning=!1,this.idleCyclesWithoutWork=0,this.IDLE_STOP_CYCLES=40,this.lastLoopAt=null,this.MAX_CONCURRENT_JOBS=5,this.PROCESSING_INTERVAL=3e4,a&&this.startProcessing()}async scheduleJob(a,b,c,e,g,h={}){try{let i=this.generateJobId(a,c,e),j={id:i,competitorId:a,userId:b,jobType:c,url:e,priority:this.calculateJobPriority(a,c),frequency:g,nextRunAt:this.calculateNextRun(g),retryCount:0,maxRetries:3,status:"pending",config:{...f,...h},createdAt:new Date,updatedAt:new Date};return this.jobQueue.set(i,j),this.updateMetrics(),(0,d.fH)(`Scheduled scraping job: ${i} for ${e}`),i}catch(a){throw(0,d.vV)("Error in scheduleJob:",a),a}}async scheduleCompetitorJobs(a,b){let c=[],d=this.getFrequencyByThreatLevel(a.threatLevel);if(a.domain){let e=await this.scheduleJob(a.id,b,"website",`https://${a.domain}`,d);c.push(e);let f=this.guessPricingUrl(a.domain);if(f){let e=await this.scheduleJob(a.id,b,"pricing",f,d);c.push(e)}let g=this.guessProductUrl(a.domain);if(g){let e=await this.scheduleJob(a.id,b,"products",g,d);c.push(e)}let h=this.guessJobsUrl(a.domain);if(h){let e=await this.scheduleJob(a.id,b,"jobs",h,{...d,type:"interval",value:2*d.value});c.push(e)}}return c}async executeJob(a){let b=this.jobQueue.get(a);if(!b)throw Error(`Job not found: ${a}`);if(this.runningJobs.has(a))throw Error(`Job already running: ${a}`);return await this.processJob(b)}pauseJob(a){let b=this.jobQueue.get(a);return!!b&&(b.status="paused",b.updatedAt=new Date,this.updateMetrics(),!0)}resumeJob(a){let b=this.jobQueue.get(a);return!!b&&"paused"===b.status&&(b.status="pending",b.nextRunAt=this.calculateNextRun(b.frequency),b.updatedAt=new Date,this.updateMetrics(),!0)}cancelJob(a){let b=this.jobQueue.get(a);return!!b&&(this.runningJobs.has(a)?b.status="cancelled":this.jobQueue.delete(a),this.updateMetrics(),!0)}getJob(a){return this.jobQueue.get(a)||null}getCompetitorJobs(a){return Array.from(this.jobQueue.values()).filter(b=>b.competitorId===a)}getJobHistory(a){return this.jobHistory.get(a)||[]}getMetrics(){return{...this.metrics}}validateScrapingResult(a,b){let c={isValid:!0,errors:[],warnings:[],confidence:1};if(!a.success)return c.isValid=!1,c.errors.push(a.error||"Scraping failed"),c.confidence=0,c;if(!a.data)return c.isValid=!1,c.errors.push("No data returned from scraping"),c.confidence=0,c;switch(b.jobType){case"website":c.confidence*=this.validateWebsiteData(a.data);break;case"pricing":c.confidence*=this.validatePricingData(a.data);break;case"products":c.confidence*=this.validateProductData(a.data);break;case"jobs":c.confidence*=this.validateJobData(a.data)}return a.responseTime>3e4&&(c.warnings.push("Slow response time detected"),c.confidence*=.9),a.cached&&(c.warnings.push("Using cached data"),c.confidence*=.95),c}startProcessing(){this.isRunning||(this.isRunning=!0,this.processingInterval=setInterval(()=>{this.processQueue().then(a=>{this.lastLoopAt=new Date,0===a?(this.idleCyclesWithoutWork+=1,this.idleCyclesWithoutWork>=this.IDLE_STOP_CYCLES&&((0,d.fH)("No scraping jobs to process for a while; stopping scheduler to save resources"),this.stopProcessing(),this.idleCyclesWithoutWork=0)):this.idleCyclesWithoutWork=0}).catch(a=>(0,d.vV)("Error in scheduler loop:",a))},this.PROCESSING_INTERVAL),(0,d.fH)("Scraping scheduler started"))}getStatus(){return{running:!!this.processingInterval,lastLoopAt:this.lastLoopAt?this.lastLoopAt.toISOString():null,metrics:this.getMetrics()}}stopProcessing(){this.isRunning&&(this.isRunning=!1,this.processingInterval&&(clearInterval(this.processingInterval),this.processingInterval=void 0),(0,d.fH)("Scraping scheduler stopped"))}async processQueue(){if(this.runningJobs.size>=this.MAX_CONCURRENT_JOBS)return 0;let a=Array.from(this.jobQueue.values()).filter(a=>"pending"===a.status&&a.nextRunAt<=new Date&&!this.runningJobs.has(a.id)).sort((a,b)=>{let c={critical:4,high:3,medium:2,low:1},d=c[b.priority]-c[a.priority];return 0!==d?d:a.nextRunAt.getTime()-b.nextRunAt.getTime()}).slice(0,this.MAX_CONCURRENT_JOBS-this.runningJobs.size);for(let b of a)this.processJob(b).catch(a=>{(0,d.vV)(`Error processing job ${b.id}:`,a)});return a.length}async processJob(a){if("cancelled"===a.status)return this._cleanupCancelledJob(a.id),{jobId:a.id,success:!1,error:"Job cancelled before execution",executionTime:0,changesDetected:!1,retryCount:a.retryCount,completedAt:new Date};let b=Date.now();try{let c;switch((0,d.fH)(`Processing scraping job: ${a.id} (${a.jobType}) for ${a.url}`),this.runningJobs.add(a.id),a.status="running",a.lastRunAt=new Date,a.updatedAt=new Date,a.jobType){case"website":c=await e.webScrapingService.scrapeCompetitorWebsite(a.url);break;case"pricing":c=await e.webScrapingService.monitorPricingPages(a.url);break;case"products":c=await e.webScrapingService.trackProductPages(a.url);break;case"jobs":c=await e.webScrapingService.scrapeJobPostings(a.url);break;default:throw Error(`Unknown job type: ${a.jobType}`)}let f=this.validateScrapingResult(c,a),g={jobId:a.id,success:c.success&&f.isValid,data:c.data,error:c.error||(f.errors.length>0?f.errors.join("; "):void 0),executionTime:Date.now()-b,changesDetected:!1,retryCount:a.retryCount,completedAt:new Date};g.success?(a.status="completed",a.retryCount=0,a.nextRunAt=this.calculateNextRun(a.frequency),this.metrics.completedJobs++):"cancelled"!==a.status&&(a.retryCount++,a.retryCount<=a.maxRetries?(a.status="pending",a.nextRunAt=this.calculateRetryTime(a.retryCount),(0,d.vV)(`Job ${a.id} failed, scheduling retry ${a.retryCount}/${a.maxRetries}`)):(a.status="failed",a.nextRunAt=this.calculateNextRun(a.frequency),this.metrics.failedJobs++,(0,d.vV)(`Job ${a.id} failed permanently after ${a.maxRetries} retries`)));let h=this.jobHistory.get(a.id)||[];return h.push(g),h.length>10&&h.splice(0,h.length-10),this.jobHistory.set(a.id,h),a.updatedAt=new Date,this.updateMetrics(),g}catch(d){a.retryCount++;let c={jobId:a.id,success:!1,error:d instanceof Error?d.message:"Unknown processing error",executionTime:Date.now()-b,changesDetected:!1,retryCount:a.retryCount,completedAt:new Date};return a.retryCount<=a.maxRetries?(a.status="pending",a.nextRunAt=this.calculateRetryTime(a.retryCount)):(a.status="failed",a.nextRunAt=this.calculateNextRun(a.frequency),this.metrics.failedJobs++),a.updatedAt=new Date,this.updateMetrics(),c}finally{this.runningJobs.delete(a.id),"cancelled"===a.status&&this._cleanupCancelledJob(a.id)}}_cleanupCancelledJob(a){this.jobQueue.delete(a),(0,d.fH)(`Cleaned up cancelled job: ${a}`),this.updateMetrics()}generateJobId(a,b,c){let d=Buffer.from(`${a}-${b}-${c}`).toString("base64");return`job_${d.replace(/[^a-zA-Z0-9]/g,"").substring(0,16)}`}calculateJobPriority(a,b){return"pricing"===b?"high":"website"===b||"products"===b?"medium":"jobs"===b?"low":"medium"}getFrequencyByThreatLevel(a){switch(a){case"critical":return{type:"interval",value:60};case"high":return{type:"interval",value:240};case"medium":return{type:"interval",value:720};default:return{type:"interval",value:1440}}}calculateNextRun(a){let b=new Date;switch(a.type){case"interval":let c="number"==typeof a.value?a.value:parseInt(a.value);return new Date(b.getTime()+60*c*1e3);case"cron":return new Date(b.getTime()+36e5);default:return new Date(b.getTime()+31536e6)}}calculateRetryTime(a){let b=Math.pow(2,a);return new Date(Date.now()+60*b*1e3)}guessPricingUrl(a){return`https://${a}/pricing`}guessProductUrl(a){return`https://${a}/products`}guessJobsUrl(a){return`https://${a}/careers`}validateWebsiteData(a){if(!a||"object"!=typeof a)return 0;let b=1;return a.title||(b*=.8),a.description||(b*=.9),(!a.content||a.content.length<100)&&(b*=.7),b}validatePricingData(a){if(!a||!a.plans||!Array.isArray(a.plans))return 0;let b=1;if(0===a.plans.length)return 0;for(let c of a.plans)c.name&&"number"==typeof c.price||(b*=.5);return b}validateProductData(a){if(!a||!a.products||!Array.isArray(a.products))return 0;let b=1;if(0===a.products.length)return 0;for(let c of a.products)c.name||(b*=.7);return b}validateJobData(a){if(!Array.isArray(a))return 0;let b=1;if(0===a.length)return .5;for(let c of a)c.title&&c.description||(b*=.8);return b}updateMetrics(){let a=Array.from(this.jobQueue.values());this.metrics.totalJobs=a.length,this.metrics.pendingJobs=a.filter(a=>"pending"===a.status).length,this.metrics.runningJobs=this.runningJobs.size,this.metrics.completedJobs=a.filter(a=>"completed"===a.status).length,this.metrics.failedJobs=a.filter(a=>"failed"===a.status).length;let b=this.metrics.completedJobs+this.metrics.failedJobs;this.metrics.successRate=b>0?this.metrics.completedJobs/b:0;let c=Array.from(this.jobHistory.values()).flat();if(c.length>0){let a=c.reduce((a,b)=>a+b.executionTime,0);this.metrics.averageExecutionTime=a/c.length}}start(){this.startProcessing()}destroy(){this.stopProcessing(),this.jobQueue.clear(),this.runningJobs.clear(),this.jobHistory.clear()}stop(){this.stopProcessing()}_setJobAsRunningForTesting(a){throw Error("This method is for testing purposes only.")}}let h=new g(!0)}};