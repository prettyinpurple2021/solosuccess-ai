exports.id=6834,exports.ids=[4291,6834],exports.modules={30477:(a,b,c)=>{"use strict";c.d(b,{HG:()=>i,JE:()=>g,fH:()=>h,vF:()=>e,vV:()=>f});class d{constructor(){this.isDevelopment=!1,this.logLevel=this.isDevelopment?3:2}shouldLog(a){return a<=this.logLevel}formatLogEntry(a){let b=["ERROR","WARN","INFO","DEBUG"][a.level],c=`[${a.timestamp}] ${b}: ${a.message}`;return a.context&&Object.keys(a.context).length>0&&(c+=` | Context: ${JSON.stringify(a.context)}`),a.error&&(c+=` | Error: ${a.error.message}`,this.isDevelopment&&a.error.stack&&(c+=` | Stack: ${a.error.stack}`)),c}log(a,b,c,d){if(!this.shouldLog(a))return;let e={level:a,message:b,timestamp:new Date().toISOString(),context:c,error:d},f=this.formatLogEntry(e);0===a&&console.error(f),!this.isDevelopment&&a<=1&&this.sendToExternalService(e)}async sendToExternalService(a){}error(a,b,c){this.log(0,a,b,c)}warn(a,b){this.log(1,a,b)}info(a,b){this.log(2,a,b)}debug(a,b){this.log(3,a,b)}apiLog(a,b,c,d,e){let f=`${a} ${b} - ${c}${d?` (${d}ms)`:""}`,g=c>=500?0:c>=400?1:2;this.log(g,f,{method:a,path:b,statusCode:c,duration:d,...e})}dbLog(a,b,c,d){let e=`DB ${a} on ${b}${c?` (${c}ms)`:""}`;this.log(3,e,{operation:a,table:b,duration:c,...d})}authLog(a,b,c=!0,d){let e=`Auth ${a}${b?` for user ${b}`:""} - ${c?"SUCCESS":"FAILED"}`;this.log(c?2:1,e,{action:a,userId:b,success:c,...d})}}let e=new d,f=(a,b,c)=>{b instanceof Error?e.error(a,void 0,b):"object"==typeof b&&null!==b?e.error(a,b,c):e.error(a,void 0,c)},g=(a,b)=>e.warn(a,b),h=(a,b)=>e.info(a,b),i=(a,b,c,d,f)=>e.apiLog(a,b,c,d,f)},42981:(a,b,c)=>{"use strict";function d(a,b,c,d){let e,f=(globalThis.__rateLimits||(globalThis.__rateLimits=new Map),(e=globalThis.__rateLimits.get(a))||(e=new Map,globalThis.__rateLimits.set(a,e)),e),g=Date.now(),h=f.get(b);if(!h||g-h.ts>c)return f.set(b,{count:1,ts:g}),{allowed:!0,remaining:d-1};h.count+=1,h.ts=g;let i=Math.max(0,d-h.count);return{allowed:h.count<=d,remaining:i}}async function e(a,b){let c=function(a){let b=a.headers.get("x-forwarded-for");if(b)return b.split(",")[0].trim();let c=a.headers.get("x-real-ip");if(c)return c;let d=a.headers.get("cf-connecting-ip");return d||"127.0.0.1"}(a),e=d(a.url||"default",c,1e3*b.window,b.requests);return{...e,success:e.allowed}}function f(a,b,c,f){if(a instanceof Request&&"object"==typeof b)return e(a,b);if("string"==typeof a&&"string"==typeof b&&c&&f)return d(a,b,c,f);throw Error("Invalid rateLimitByIp arguments")}c.d(b,{E:()=>f})},62114:(a,b,c)=>{"use strict";c.d(b,{h:()=>k});var d=c(30477),e=c(48689),f=c(20862),g=c(71559),h=c(97356),i=c(41393),j=c(90080);class k{static getInstance(){return k.instance||(k.instance=new k),k.instance}async createJob(a){let b=(0,j.A)(),c=this.calculateNextRun(a.frequencyType||"interval",a.frequencyValue,a.frequencyTimezone??void 0);return await h.db.insert(i.scrapingJobs).values({id:b,competitor_id:a.competitorId,user_id:a.userId,job_type:a.jobType,url:a.url,priority:a.priority||"medium",frequency_type:a.frequencyType||"interval",frequency_value:a.frequencyValue,frequency_timezone:a.frequencyTimezone,next_run_at:c,max_retries:a.maxRetries||3,config:a.config||{},status:"pending"}),this.scheduleJob(b,c),b}async getJobsToRun(){let a=new Date;return await h.db.select().from(i.scrapingJobs).where((0,e.Uo)((0,e.wJ)(i.scrapingJobs.next_run_at,a),(0,e.RV)(i.scrapingJobs.status,["pending","failed"]),(0,e.or)((0,e.kZ)(i.scrapingJobs.last_run_at),(0,f.ll)`${i.scrapingJobs.retry_count} < ${i.scrapingJobs.max_retries}`))).orderBy((0,g.i)(i.scrapingJobs.priority),(0,g.Y)(i.scrapingJobs.next_run_at)).limit(10)}async updateJobStatus(a,b,c){let d={status:b};c&&(d.last_run_at=c),await h.db.update(i.scrapingJobs).set(d).where((0,e.eq)(i.scrapingJobs.id,a))}async recordJobResult(a,b){await h.db.insert(i.scrapingJobResults).values({job_id:a,success:b.success,data:b.data,error:b.error,execution_time:b.executionTime,changes_detected:b.changesDetected,retry_count:b.retryCount});let c=await h.db.select().from(i.scrapingJobs).where((0,e.eq)(i.scrapingJobs.id,a)).limit(1);if(0===c.length)return;let d=c[0];if(b.success){let c=this.calculateNextRun(d.frequency_type,d.frequency_value,d.frequency_timezone??void 0);await h.db.update(i.scrapingJobs).set({status:"completed",last_run_at:new Date,next_run_at:c,retry_count:0}).where((0,e.eq)(i.scrapingJobs.id,a)),this.scheduleJob(a,c),b.changesDetected&&b.data&&await this.storeIntelligenceData(d,b.data)}else{let b=d.retry_count+1;if(b>=d.max_retries)await h.db.update(i.scrapingJobs).set({status:"failed",retry_count:b}).where((0,e.eq)(i.scrapingJobs.id,a));else{let c=this.calculateRetryDelay(b),d=new Date(Date.now()+c);await h.db.update(i.scrapingJobs).set({status:"pending",retry_count:b,next_run_at:d}).where((0,e.eq)(i.scrapingJobs.id,a)),this.scheduleJob(a,d)}}}scheduleJob(a,b){let c=this.jobQueue.get(a);c&&clearTimeout(c);let d=b.getTime()-Date.now();if(d<=0)this.executeJob(a);else{let b=setTimeout(()=>{this.executeJob(a)},d);this.jobQueue.set(a,b)}}async executeJob(a){if(!this.runningJobs.has(a)){this.runningJobs.add(a),this.jobQueue.delete(a);try{await this.updateJobStatus(a,"running",new Date);let b=await h.db.select().from(i.scrapingJobs).where((0,e.eq)(i.scrapingJobs.id,a)).limit(1);if(0===b.length)throw Error(`Job ${a} not found`);let c=b[0],d=Date.now(),f=await this.performScraping(c),g=Date.now()-d;await this.recordJobResult(a,{...f,executionTime:g,retryCount:c.retry_count})}catch(b){(0,d.vV)(`Error executing job ${a}:`,b),await this.recordJobResult(a,{success:!1,error:b instanceof Error?b.message:"Unknown error",executionTime:0,changesDetected:!1,retryCount:0})}finally{this.runningJobs.delete(a)}}}async performScraping(a){try{let{webScrapingService:b}=await Promise.all([c.e(7615),c.e(1993),c.e(6685)]).then(c.bind(c,76685));switch(a.job_type){case"website":{let c=await b.scrapeCompetitorWebsite(a.url);if(!c.success)return{success:!1,error:c.error||"Scraping failed",changesDetected:!1};return{success:!0,data:c.data,changesDetected:!1}}case"pricing":{let c=await b.monitorPricingPages(a.url);if(!c.success)return{success:!1,error:c.error||"Pricing monitoring failed",changesDetected:!1};return{success:!0,data:c.data,changesDetected:!1}}case"products":{let c=await b.trackProductPages(a.url);if(!c.success)return{success:!1,error:c.error||"Product tracking failed",changesDetected:!1};return{success:!0,data:c.data,changesDetected:!1}}case"jobs":{let c=await b.scrapeJobPostings(a.url);if(!c.success)return{success:!1,error:c.error||"Job scraping failed",changesDetected:!1};return{success:!0,data:c.data,changesDetected:!1}}case"social":return{success:!1,error:"Use SocialMediaMonitor for social jobs",changesDetected:!1};default:return{success:!1,error:`Unsupported job type: ${a.job_type}`,changesDetected:!1}}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Scraping failed",changesDetected:!1}}}async storeIntelligenceData(a,b){await h.db.insert(i.intelligenceData).values({competitor_id:a.competitor_id,user_id:a.user_id,source_type:"website",source_url:a.url,data_type:a.job_type,raw_content:b,extracted_data:{jobId:a.id,scrapedAt:new Date().toISOString(),changeDetected:!0},importance:this.mapPriorityToImportance(a.priority),tags:[a.job_type,"automated"],collected_at:new Date})}calculateNextRun(a,b,c){let d=new Date;switch(a){case"interval":let e=parseInt(b,10);return new Date(d.getTime()+60*e*1e3);case"cron":default:return new Date(d.getTime()+36e5);case"manual":return new Date(d.getTime()+31536e6)}}calculateRetryDelay(a){let b=60*Math.min(Math.pow(2,a),60)*1e3,c=.1*Math.random()*b;return b+c}mapPriorityToImportance(a){switch(a){case"critical":return"critical";case"high":return"high";case"medium":default:return"medium";case"low":return"low"}}async start(){(0,d.fH)("Starting scraping scheduler...");let a=await h.db.select().from(i.scrapingJobs).where((0,e.RV)(i.scrapingJobs.status,["pending","failed"]));for(let b of a)this.scheduleJob(b.id,b.next_run_at);(0,d.fH)(`Scheduled ${a.length} existing jobs`)}stop(){for(let a of((0,d.fH)("Stopping scraping scheduler..."),this.jobQueue.values()))clearTimeout(a);this.jobQueue.clear(),(0,d.fH)("Scraping scheduler stopped")}async getJobStats(a){let b=h.db.select({status:i.scrapingJobs.status,count:(0,f.ll)`count(*)`}).from(i.scrapingJobs),c=a?b.where((0,e.eq)(i.scrapingJobs.user_id,a)):b;return(await c.groupBy(i.scrapingJobs.status)).reduce((a,b)=>(a[b.status]=b.count,a),{})}async pauseJob(a){await this.updateJobStatus(a,"paused");let b=this.jobQueue.get(a);b&&(clearTimeout(b),this.jobQueue.delete(a))}async resumeJob(a){let b=await h.db.select().from(i.scrapingJobs).where((0,e.eq)(i.scrapingJobs.id,a)).limit(1);if(0===b.length)throw Error(`Job ${a} not found`);let c=b[0],d=this.calculateNextRun(c.frequency_type,c.frequency_value,c.frequency_timezone??void 0);await h.db.update(i.scrapingJobs).set({status:"pending",next_run_at:d}).where((0,e.eq)(i.scrapingJobs.id,a)),this.scheduleJob(a,d)}async deleteJob(a){let b=this.jobQueue.get(a);b&&(clearTimeout(b),this.jobQueue.delete(a)),this.runningJobs.delete(a),await h.db.delete(i.scrapingJobs).where((0,e.eq)(i.scrapingJobs.id,a))}constructor(){this.jobQueue=new Map,this.runningJobs=new Set}}},74291:(a,b,c)=>{"use strict";c.d(b,{_:()=>m,authenticateRequest:()=>l});var d=c(30477);c(10641);var e=c(86802),f=c(80829),g=c.n(f),h=c(94570),i=c(41393),j=c(48689);async function k(){try{let a=await (0,e.b3)(),b=a.get("authorization"),c=null;if(b&&b.startsWith("Bearer "))c=b.substring(7);else{let b=a.get("cookie");b&&(c=b.split(";").reduce((a,b)=>{let[c,d]=b.trim().split("=");return a[c]=d,a},{}).auth_token||null)}if(!c)return null;let d=g().verify(c,"local-development-jwt-secret-key");if(!d||!d.userId)return null;let f=(0,h.Lf)(),k=await f.select({id:i.users.id,email:i.users.email,full_name:i.users.full_name,username:i.users.username,date_of_birth:i.users.date_of_birth,created_at:i.users.created_at,updated_at:i.users.updated_at,subscription_tier:i.users.subscription_tier,subscription_status:i.users.subscription_status}).from(i.users).where((0,j.eq)(i.users.id,d.userId)).limit(1);if(0===k.length)return null;let l=k[0];return{id:l.id,email:l.email,full_name:l.full_name,name:l.full_name,username:l.username,created_at:l.created_at,updated_at:l.updated_at,subscription_tier:l.subscription_tier??"free",subscription_status:l.subscription_status??"active"}}catch(a){return(0,d.vV)("JWT authentication error:",a),null}}async function l(){try{let a=await k();if(a)return{user:a,error:null};return{user:null,error:"No authenticated user session found"}}catch(a){return(0,d.vV)("Authentication error:",a),{user:null,error:"Authentication failed"}}}async function m(a){try{let a=await l();return{user:a.user||void 0,error:a.error||void 0}}catch(a){return(0,d.vV)("verifyAuth error:",a),{error:"Authentication failed"}}}},78335:()=>{},90080:(a,b,c)=>{"use strict";c.d(b,{A:()=>j});var d=c(55511),e=c.n(d);let f={randomUUID:e().randomUUID},g=new Uint8Array(256),h=g.length,i=[];for(let a=0;a<256;++a)i.push((a+256).toString(16).slice(1));let j=function(a,b,c){if(f.randomUUID&&!b&&!a)return f.randomUUID();let d=(a=a||{}).random||(a.rng||function(){return h>g.length-16&&(e().randomFillSync(g),h=0),g.slice(h,h+=16)})();if(d[6]=15&d[6]|64,d[8]=63&d[8]|128,b){c=c||0;for(let a=0;a<16;++a)b[c+a]=d[a];return b}return function(a,b=0){return i[a[b+0]]+i[a[b+1]]+i[a[b+2]]+i[a[b+3]]+"-"+i[a[b+4]]+i[a[b+5]]+"-"+i[a[b+6]]+i[a[b+7]]+"-"+i[a[b+8]]+i[a[b+9]]+"-"+i[a[b+10]]+i[a[b+11]]+i[a[b+12]]+i[a[b+13]]+i[a[b+14]]+i[a[b+15]]}(d)}},96487:()=>{},97356:(a,b,c)=>{"use strict";c.d(b,{db:()=>d.db});var d=c(94570);c(41393)}};