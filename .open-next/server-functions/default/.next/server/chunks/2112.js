"use strict";exports.id=2112,exports.ids=[2112],exports.modules={2112:(a,b,c)=>{c.d(b,{pY:()=>cn,Df:()=>b0,gM:()=>ch});var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B=c(96075),C=c(13092),D=c(10522),E=Symbol.for("vercel.ai.gateway.error"),F=class a extends(e=Error,d=E,e){constructor({message:a,statusCode:b=500,cause:c}){super(a),this[d]=!0,this.statusCode=b,this.cause=c}static isInstance(b){return a.hasMarker(b)}static hasMarker(a){return"object"==typeof a&&null!==a&&E in a&&!0===a[E]}},G="GatewayAuthenticationError",H=Symbol.for(`vercel.ai.gateway.error.${G}`),I=class a extends(g=F,f=H,g){constructor({message:a="Authentication failed",statusCode:b=401,cause:c}={}){super({message:a,statusCode:b,cause:c}),this[f]=!0,this.name=G,this.type="authentication_error"}static isInstance(a){return F.hasMarker(a)&&H in a}static createContextualError({apiKeyProvided:b,oidcTokenProvided:c,message:d="Authentication failed",statusCode:e=401,cause:f}){return new a({message:b?`AI Gateway authentication failed: Invalid API key provided.

The token is expected to be provided via the 'apiKey' option or 'AI_GATEWAY_API_KEY' environment variable.`:c?`AI Gateway authentication failed: Invalid OIDC token provided.

The token is expected to be provided via the 'VERCEL_OIDC_TOKEN' environment variable. It expires every 12 hours.
- make sure your Vercel project settings have OIDC enabled
- if running locally with 'vercel dev', the token is automatically obtained and refreshed
- if running locally with your own dev server, run 'vercel env pull' to fetch the token
- in production/preview, the token is automatically obtained and refreshed

Alternative: Provide an API key via 'apiKey' option or 'AI_GATEWAY_API_KEY' environment variable.`:`AI Gateway authentication failed: No authentication provided.

Provide either an API key or OIDC token.

API key instructions:

The token is expected to be provided via the 'apiKey' option or 'AI_GATEWAY_API_KEY' environment variable.

OIDC token instructions:

The token is expected to be provided via the 'VERCEL_OIDC_TOKEN' environment variable. It expires every 12 hours.
- make sure your Vercel project settings have OIDC enabled
- if running locally with 'vercel dev', the token is automatically obtained and refreshed
- if running locally with your own dev server, run 'vercel env pull' to fetch the token
- in production/preview, the token is automatically obtained and refreshed`,statusCode:e,cause:f})}},J="GatewayInvalidRequestError",K=Symbol.for(`vercel.ai.gateway.error.${J}`),L=class extends(i=F,h=K,i){constructor({message:a="Invalid request",statusCode:b=400,cause:c}={}){super({message:a,statusCode:b,cause:c}),this[h]=!0,this.name=J,this.type="invalid_request_error"}static isInstance(a){return F.hasMarker(a)&&K in a}},M="GatewayRateLimitError",N=Symbol.for(`vercel.ai.gateway.error.${M}`),O=class extends(k=F,j=N,k){constructor({message:a="Rate limit exceeded",statusCode:b=429,cause:c}={}){super({message:a,statusCode:b,cause:c}),this[j]=!0,this.name=M,this.type="rate_limit_exceeded"}static isInstance(a){return F.hasMarker(a)&&N in a}},P="GatewayModelNotFoundError",Q=Symbol.for(`vercel.ai.gateway.error.${P}`),R=D.Ik({modelId:D.Yj()}),S=class extends(m=F,l=Q,m){constructor({message:a="Model not found",statusCode:b=404,modelId:c,cause:d}={}){super({message:a,statusCode:b,cause:d}),this[l]=!0,this.name=P,this.type="model_not_found",this.modelId=c}static isInstance(a){return F.hasMarker(a)&&Q in a}},T="GatewayInternalServerError",U=Symbol.for(`vercel.ai.gateway.error.${T}`),V=class extends(o=F,n=U,o){constructor({message:a="Internal server error",statusCode:b=500,cause:c}={}){super({message:a,statusCode:b,cause:c}),this[n]=!0,this.name=T,this.type="internal_server_error"}static isInstance(a){return F.hasMarker(a)&&U in a}},W="GatewayResponseError",X=Symbol.for(`vercel.ai.gateway.error.${W}`),Y=class extends(q=F,p=X,q){constructor({message:a="Invalid response from Gateway",statusCode:b=502,response:c,validationError:d,cause:e}={}){super({message:a,statusCode:b,cause:e}),this[p]=!0,this.name=W,this.type="response_error",this.response=c,this.validationError=d}static isInstance(a){return F.hasMarker(a)&&X in a}};function Z({response:a,statusCode:b,defaultMessage:c="Gateway request failed",cause:d,authMethod:e}){let f=$.safeParse(a);if(!f.success)return new Y({message:`Invalid error response format: ${c}`,statusCode:b,response:a,validationError:f.error,cause:d});let g=f.data,h=g.error.type,i=g.error.message;switch(h){case"authentication_error":return I.createContextualError({apiKeyProvided:"api-key"===e,oidcTokenProvided:"oidc"===e,statusCode:b,cause:d});case"invalid_request_error":return new L({message:i,statusCode:b,cause:d});case"rate_limit_exceeded":return new O({message:i,statusCode:b,cause:d});case"model_not_found":{let a=R.safeParse(g.error.param);return new S({message:i,statusCode:b,modelId:a.success?a.data.modelId:void 0,cause:d})}default:return new V({message:i,statusCode:b,cause:d})}}var $=D.Ik({error:D.Ik({message:D.Yj(),type:D.Yj().nullish(),param:D.L5().nullish(),code:D.KC([D.Yj(),D.ai()]).nullish()})});function _(a,b){var c;return F.isInstance(a)?a:C.hL.isInstance(a)?Z({response:function(a){if(void 0!==a.data)return a.data;if(null!=a.responseBody)try{return JSON.parse(a.responseBody)}catch(b){return a.responseBody}return{}}(a),statusCode:null!=(c=a.statusCode)?c:500,defaultMessage:"Gateway request failed",cause:a,authMethod:b}):Z({response:{},statusCode:500,defaultMessage:a instanceof Error?`Gateway request failed: ${a.message}`:"Unknown Gateway error",cause:a,authMethod:b})}var aa="ai-gateway-auth-method";function ab(a){let b=ac.safeParse(a[aa]);return b.success?b.data:void 0}var ac=D.KC([D.eu("api-key"),D.eu("oidc")]),ad=class{constructor(a){this.config=a}async getAvailableModels(){try{let{value:a}=await (0,B.$b)({url:`${this.config.baseURL}/config`,headers:await (0,B.hd)(this.config.headers()),successfulResponseHandler:(0,B.cV)(ah),failedResponseHandler:(0,B.sl)({errorSchema:D.bz(),errorToMessage:a=>a}),fetch:this.config.fetch});return a}catch(a){throw _(a)}}async getCredits(){try{let a=new URL(this.config.baseURL),{value:b}=await (0,B.$b)({url:`${a.origin}/v1/credits`,headers:await (0,B.hd)(this.config.headers()),successfulResponseHandler:(0,B.cV)(ai),failedResponseHandler:(0,B.sl)({errorSchema:D.bz(),errorToMessage:a=>a}),fetch:this.config.fetch});return b}catch(a){throw _(a)}}},ae=D.Ik({specificationVersion:D.eu("v2"),provider:D.Yj(),modelId:D.Yj()}),af=D.Ik({input:D.Yj(),output:D.Yj(),input_cache_read:D.Yj().nullish(),input_cache_write:D.Yj().nullish()}).transform(({input:a,output:b,input_cache_read:c,input_cache_write:d})=>({input:a,output:b,...c?{cachedInputTokens:c}:{},...d?{cacheCreationInputTokens:d}:{}})),ag=D.Ik({id:D.Yj(),name:D.Yj(),description:D.Yj().nullish(),pricing:af.nullish(),specification:ae,modelType:D.k5(["language","embedding","image"]).nullish()}),ah=D.Ik({models:D.YO(ag)}),ai=D.Ik({balance:D.Yj(),total_used:D.Yj()}).transform(({balance:a,total_used:b})=>({balance:a,totalUsed:b})),aj=class{constructor(a,b){this.modelId=a,this.config=b,this.specificationVersion="v2",this.supportedUrls={"*/*":[/.*/]}}get provider(){return this.config.provider}async getArgs(a){let{abortSignal:b,...c}=a;return{args:this.maybeEncodeFileParts(c),warnings:[]}}async doGenerate(a){let{args:b,warnings:c}=await this.getArgs(a),{abortSignal:d}=a,e=await (0,B.hd)(this.config.headers());try{let{responseHeaders:f,value:g,rawValue:h}=await (0,B.GU)({url:this.getUrl(),headers:(0,B.m2)(e,a.headers,this.getModelConfigHeaders(this.modelId,!1),await (0,B.hd)(this.config.o11yHeaders)),body:b,successfulResponseHandler:(0,B.cV)(D.bz()),failedResponseHandler:(0,B.sl)({errorSchema:D.bz(),errorToMessage:a=>a}),...d&&{abortSignal:d},fetch:this.config.fetch});return{...g,request:{body:b},response:{headers:f,body:h},warnings:c}}catch(a){throw _(a,ab(e))}}async doStream(a){let{args:b,warnings:c}=await this.getArgs(a),{abortSignal:d}=a,e=await (0,B.hd)(this.config.headers());try{let{value:f,responseHeaders:g}=await (0,B.GU)({url:this.getUrl(),headers:(0,B.m2)(e,a.headers,this.getModelConfigHeaders(this.modelId,!0),await (0,B.hd)(this.config.o11yHeaders)),body:b,successfulResponseHandler:(0,B.Ds)(D.bz()),failedResponseHandler:(0,B.sl)({errorSchema:D.bz(),errorToMessage:a=>a}),...d&&{abortSignal:d},fetch:this.config.fetch});return{stream:f.pipeThrough(new TransformStream({start(a){c.length>0&&a.enqueue({type:"stream-start",warnings:c})},transform(b,c){if(b.success){let d=b.value;("raw"!==d.type||a.includeRawChunks)&&("response-metadata"===d.type&&d.timestamp&&"string"==typeof d.timestamp&&(d.timestamp=new Date(d.timestamp)),c.enqueue(d))}else c.error(b.error)}})),request:{body:b},response:{headers:g}}}catch(a){throw _(a,ab(e))}}isFilePart(a){return a&&"object"==typeof a&&"type"in a&&"file"===a.type}maybeEncodeFileParts(a){for(let b of a.prompt)for(let a of b.content)if(this.isFilePart(a)&&a.data instanceof Uint8Array){let b=Uint8Array.from(a.data),c=Buffer.from(b).toString("base64");a.data=new URL(`data:${a.mediaType||"application/octet-stream"};base64,${c}`)}return a}getUrl(){return`${this.config.baseURL}/language-model`}getModelConfigHeaders(a,b){return{"ai-language-model-specification-version":"2","ai-language-model-id":a,"ai-language-model-streaming":String(b)}}},ak=class{constructor(a,b){this.modelId=a,this.config=b,this.specificationVersion="v2",this.maxEmbeddingsPerCall=2048,this.supportsParallelCalls=!0}get provider(){return this.config.provider}async doEmbed({values:a,headers:b,abortSignal:c,providerOptions:d}){var e;let f=await (0,B.hd)(this.config.headers());try{let{responseHeaders:g,value:h,rawValue:i}=await (0,B.GU)({url:this.getUrl(),headers:(0,B.m2)(f,null!=b?b:{},this.getModelConfigHeaders(),await (0,B.hd)(this.config.o11yHeaders)),body:{input:1===a.length?a[0]:a,...d?{providerOptions:d}:{}},successfulResponseHandler:(0,B.cV)(al),failedResponseHandler:(0,B.sl)({errorSchema:D.bz(),errorToMessage:a=>a}),...c&&{abortSignal:c},fetch:this.config.fetch});return{embeddings:h.embeddings,usage:null!=(e=h.usage)?e:void 0,providerMetadata:h.providerMetadata,response:{headers:g,body:i}}}catch(a){throw _(a,ab(f))}}getUrl(){return`${this.config.baseURL}/embedding-model`}getModelConfigHeaders(){return{"ai-embedding-model-specification-version":"2","ai-model-id":this.modelId}}},al=D.Ik({embeddings:D.YO(D.YO(D.ai())),usage:D.Ik({tokens:D.ai()}).nullish(),providerMetadata:D.g1(D.Yj(),D.g1(D.Yj(),D.L5())).optional()});async function am(){var a,b;let c=null!=(b=null==(a=ap().headers)?void 0:a["x-vercel-oidc-token"])?b:process.env.VERCEL_OIDC_TOKEN;if(!c)throw new I({message:"OIDC token not available",statusCode:401});return c}async function an(){var a;return null==(a=ap().headers)?void 0:a["x-vercel-id"]}var ao=Symbol.for("@vercel/request-context");function ap(){var a,b,c;return null!=(c=null==(b=null==(a=globalThis[ao])?void 0:a.get)?void 0:b.call(a))?c:{}}var aq=function(a={}){var b,c;let d=null,e=null,f=null!=(b=a.metadataCacheRefreshMillis)?b:3e5,g=0,h=null!=(c=(0,B.ae)(a.baseURL))?c:"https://ai-gateway.vercel.sh/v1/ai",i=async()=>{let b=await ar(a);if(b)return(0,B.WZ)({Authorization:`Bearer ${b.token}`,"ai-gateway-protocol-version":"0.0.1",[aa]:b.authMethod,...a.headers},"ai-sdk/gateway/1.0.30");throw I.createContextualError({apiKeyProvided:!1,oidcTokenProvided:!1,statusCode:401})},j=()=>{let a=(0,B.x3)({settingValue:void 0,environmentVariableName:"VERCEL_DEPLOYMENT_ID"}),b=(0,B.x3)({settingValue:void 0,environmentVariableName:"VERCEL_ENV"}),c=(0,B.x3)({settingValue:void 0,environmentVariableName:"VERCEL_REGION"});return async()=>{let d=await an();return{...a&&{"ai-o11y-deployment-id":a},...b&&{"ai-o11y-environment":b},...c&&{"ai-o11y-region":c},...d&&{"ai-o11y-request-id":d}}}},k=b=>new aj(b,{provider:"gateway",baseURL:h,headers:i,fetch:a.fetch,o11yHeaders:j()}),l=async()=>new ad({baseURL:h,headers:i,fetch:a.fetch}).getCredits().catch(async a=>{throw _(a,ab(await i()))}),m=function(a){if(new.target)throw Error("The Gateway Provider model function cannot be called with the new keyword.");return k(a)};return m.getAvailableModels=async()=>{var b,c,j;let k=null!=(j=null==(c=null==(b=a._internal)?void 0:b.currentDate)?void 0:c.call(b).getTime())?j:Date.now();return(!d||k-g>f)&&(g=k,d=new ad({baseURL:h,headers:i,fetch:a.fetch}).getAvailableModels().then(a=>(e=a,a)).catch(async a=>{throw _(a,ab(await i()))})),e?Promise.resolve(e):d},m.getCredits=l,m.imageModel=a=>{throw new C.eM({modelId:a,modelType:"imageModel"})},m.languageModel=k,m.textEmbeddingModel=b=>new ak(b,{provider:"gateway",baseURL:h,headers:i,fetch:a.fetch,o11yHeaders:j()}),m}();async function ar(a){let b=(0,B.x3)({settingValue:a.apiKey,environmentVariableName:"AI_GATEWAY_API_KEY"});if(b)return{token:b,authMethod:"api-key"};try{return{token:await am(),authMethod:"oidc"}}catch(a){return null}}var as=c(69907),at=c(92818),au=Object.defineProperty,av="AI_NoOutputSpecifiedError",aw=`vercel.ai.error.${av}`,ax=Symbol.for(aw),ay=class extends C.bD{constructor({message:a="No output specified."}={}){super({name:av,message:a}),this[r]=!0}static isInstance(a){return C.bD.hasMarker(a,aw)}};r=ax;var az=!1,aA=a=>{if(0===a.length)return;let b=globalThis.AI_SDK_LOG_WARNINGS;if(!1!==b){if("function"==typeof b)return void b(a);for(let b of(az||(az=!0,console.info("AI SDK Warning System: To turn off warning logging, set the AI_SDK_LOG_WARNINGS global to false.")),a))console.warn(function(a){let b="AI SDK Warning:";switch(a.type){case"unsupported-setting":{let c=`${b} The "${a.setting}" setting is not supported by this model`;return a.details&&(c+=` - ${a.details}`),c}case"unsupported-tool":{let c="name"in a.tool?a.tool.name:"unknown tool",d=`${b} The tool "${c}" is not supported by this model`;return a.details&&(d+=` - ${a.details}`),d}case"other":return`${b} ${a.message}`;default:return`${b} ${JSON.stringify(a,null,2)}`}}(b))}},aB="AI_InvalidArgumentError",aC=`vercel.ai.error.${aB}`,aD=Symbol.for(aC),aE=class extends C.bD{constructor({parameter:a,value:b,message:c}){super({name:aB,message:`Invalid argument for parameter ${a}: ${c}`}),this[s]=!0,this.parameter=a,this.value=b}static isInstance(a){return C.bD.hasMarker(a,aC)}};s=aD;Symbol.for("vercel.ai.error.AI_InvalidStreamPartError");C.bD;var aF="AI_InvalidToolInputError",aG=`vercel.ai.error.${aF}`,aH=Symbol.for(aG),aI=class extends C.bD{constructor({toolInput:a,toolName:b,cause:c,message:d=`Invalid input for tool ${b}: ${(0,C.u1)(c)}`}){super({name:aF,message:d,cause:c}),this[t]=!0,this.toolInput=a,this.toolName=b}static isInstance(a){return C.bD.hasMarker(a,aG)}};t=aH;Symbol.for("vercel.ai.error.AI_MCPClientError");C.bD;Symbol.for("vercel.ai.error.AI_NoImageGeneratedError");C.bD;var aJ="AI_NoObjectGeneratedError",aK=`vercel.ai.error.${aJ}`,aL=Symbol.for(aK),aM=class extends C.bD{constructor({message:a="No object generated.",cause:b,text:c,response:d,usage:e,finishReason:f}){super({name:aJ,message:a,cause:b}),this[u]=!0,this.text=c,this.response=d,this.usage=e,this.finishReason=f}static isInstance(a){return C.bD.hasMarker(a,aK)}};u=aL;var aN="AI_NoOutputGeneratedError",aO=`vercel.ai.error.${aN}`,aP=Symbol.for(aO),aQ=class extends C.bD{constructor({message:a="No output generated.",cause:b}={}){super({name:aN,message:a,cause:b}),this[v]=!0}static isInstance(a){return C.bD.hasMarker(a,aO)}};v=aP;var aR="AI_NoSuchToolError",aS=`vercel.ai.error.${aR}`,aT=Symbol.for(aS),aU=class extends C.bD{constructor({toolName:a,availableTools:b,message:c=`Model tried to call unavailable tool '${a}'. ${void 0===b?"No tools are available.":`Available tools: ${b.join(", ")}.`}`}){super({name:aR,message:c}),this[w]=!0,this.toolName=a,this.availableTools=b}static isInstance(a){return C.bD.hasMarker(a,aS)}};w=aT;var aV="AI_ToolCallRepairError",aW=`vercel.ai.error.${aV}`,aX=Symbol.for(aW),aY=class extends C.bD{constructor({cause:a,originalError:b,message:c=`Error repairing tool call: ${(0,C.u1)(a)}`}){super({name:aV,message:c,cause:a}),this[x]=!0,this.originalError=b}static isInstance(a){return C.bD.hasMarker(a,aW)}};x=aX;var aZ=class extends C.bD{constructor(a){super({name:"AI_UnsupportedModelVersionError",message:`Unsupported model version ${a.version} for provider "${a.provider}" and model "${a.modelId}". AI SDK 5 only supports models that implement specification version "v2".`}),this.version=a.version,this.provider=a.provider,this.modelId=a.modelId}},a$=Symbol.for("vercel.ai.error.AI_InvalidDataContentError");C.bD;var a_="AI_InvalidMessageRoleError",a0=`vercel.ai.error.${a_}`,a1=Symbol.for(a0),a2=class extends C.bD{constructor({role:a,message:b=`Invalid message role: '${a}'. Must be one of: "system", "user", "assistant", "tool".`}){super({name:a_,message:b}),this[y]=!0,this.role=a}static isInstance(a){return C.bD.hasMarker(a,a0)}};y=a1;Symbol.for("vercel.ai.error.AI_MessageConversionError");C.bD;var a3="AI_DownloadError",a4=`vercel.ai.error.${a3}`,a5=Symbol.for(a4),a6=class extends C.bD{constructor({url:a,statusCode:b,statusText:c,cause:d,message:e=null==d?`Failed to download ${a}: ${b} ${c}`:`Failed to download ${a}: ${d}`}){super({name:a3,message:e,cause:d}),this[z]=!0,this.url=a,this.statusCode=b,this.statusText=c}static isInstance(a){return C.bD.hasMarker(a,a4)}};z=a5;var a7="AI_RetryError",a8=`vercel.ai.error.${a7}`,a9=Symbol.for(a8),ba=class extends C.bD{constructor({message:a,reason:b,errors:c}){super({name:a7,message:a}),this[A]=!0,this.reason=b,this.errors=c,this.lastError=c[c.length-1]}static isInstance(a){return C.bD.hasMarker(a,a8)}};function bb(a){var b;if("string"!=typeof a){if("v2"!==a.specificationVersion)throw new aZ({version:a.specificationVersion,provider:a.provider,modelId:a.modelId});return a}return(null!=(b=globalThis.AI_SDK_DEFAULT_PROVIDER)?b:aq).languageModel(a)}A=a9;var bc=[{mediaType:"image/gif",bytesPrefix:[71,73,70]},{mediaType:"image/png",bytesPrefix:[137,80,78,71]},{mediaType:"image/jpeg",bytesPrefix:[255,216]},{mediaType:"image/webp",bytesPrefix:[82,73,70,70,null,null,null,null,87,69,66,80]},{mediaType:"image/bmp",bytesPrefix:[66,77]},{mediaType:"image/tiff",bytesPrefix:[73,73,42,0]},{mediaType:"image/tiff",bytesPrefix:[77,77,0,42]},{mediaType:"image/avif",bytesPrefix:[0,0,0,32,102,116,121,112,97,118,105,102]},{mediaType:"image/heic",bytesPrefix:[0,0,0,32,102,116,121,112,104,101,105,99]}],bd="5.0.54",be=async({url:a})=>{var b;let c=a.toString();try{let a=await fetch(c,{headers:(0,B.WZ)({},`ai-sdk/${bd}`,(0,B.G1)())});if(!a.ok)throw new a6({url:c,statusCode:a.status,statusText:a.statusText});return{data:new Uint8Array(await a.arrayBuffer()),mediaType:null!=(b=a.headers.get("content-type"))?b:void 0}}catch(a){if(a6.isInstance(a))throw a;throw new a6({url:c,cause:a})}},bf=D.KC([D.Yj(),D.Nl(Uint8Array),D.Nl(ArrayBuffer),D.Ie(a=>{var b,c;return null!=(c=null==(b=globalThis.Buffer)?void 0:b.isBuffer(a))&&c},{message:"Must be a Buffer"})]);function bg(a){if(a instanceof Uint8Array)return{data:a,mediaType:void 0};if(a instanceof ArrayBuffer)return{data:new Uint8Array(a),mediaType:void 0};if("string"==typeof a)try{a=new URL(a)}catch(a){}if(a instanceof URL&&"data:"===a.protocol){let{mediaType:b,base64Content:c}=function(a){try{let[b,c]=a.split(",");return{mediaType:b.split(";")[0].split(":")[1],base64Content:c}}catch(a){return{mediaType:void 0,base64Content:void 0}}}(a.toString());if(null==b||null==c)throw new C.bD({name:"InvalidDataContentError",message:`Invalid data URL format in content ${a.toString()}`});return{data:c,mediaType:b}}return{data:a,mediaType:void 0}}async function bh({prompt:a,supportedUrls:b,download:c=((a=be)=>b=>Promise.all(b.map(async b=>b.isUrlSupportedByModel?null:a(b))))()}){let d=await bi(a.messages,c,b);return[...null!=a.system?[{role:"system",content:a.system}]:[],...a.messages.map(a=>(function({message:a,downloadedAssets:b}){let c=a.role;switch(c){case"system":return{role:"system",content:a.content,providerOptions:a.providerOptions};case"user":if("string"==typeof a.content)return{role:"user",content:[{type:"text",text:a.content}],providerOptions:a.providerOptions};return{role:"user",content:a.content.map(a=>(function(a,b){var c;let d;if("text"===a.type)return{type:"text",text:a.text,providerOptions:a.providerOptions};let e=a.type;switch(e){case"image":d=a.image;break;case"file":d=a.data;break;default:throw Error(`Unsupported part type: ${e}`)}let{data:f,mediaType:g}=bg(d),h=null!=g?g:a.mediaType,i=f;if(i instanceof URL){let a=b[i.toString()];a&&(i=a.data,null!=h||(h=a.mediaType))}switch(e){case"image":return(i instanceof Uint8Array||"string"==typeof i)&&(h=null!=(c=function({data:a,signatures:b}){let c="string"==typeof a&&a.startsWith("SUQz")||"string"!=typeof a&&a.length>10&&73===a[0]&&68===a[1]&&51===a[2]?(a=>{let b="string"==typeof a?(0,B.Z9)(a):a,c=(127&b[6])<<21|(127&b[7])<<14|(127&b[8])<<7|127&b[9];return b.slice(c+10)})(a):a,d="string"==typeof c?(0,B.Z9)(c.substring(0,Math.min(c.length,24))):c;for(let a of b)if(d.length>=a.bytesPrefix.length&&a.bytesPrefix.every((a,b)=>null===a||d[b]===a))return a.mediaType}({data:i,signatures:bc}))?c:h),{type:"file",mediaType:null!=h?h:"image/*",filename:void 0,data:i,providerOptions:a.providerOptions};case"file":if(null==h)throw Error("Media type is missing for file part");return{type:"file",mediaType:h,filename:a.filename,data:i,providerOptions:a.providerOptions}}})(a,b)).filter(a=>"text"!==a.type||""!==a.text),providerOptions:a.providerOptions};case"assistant":if("string"==typeof a.content)return{role:"assistant",content:[{type:"text",text:a.content}],providerOptions:a.providerOptions};return{role:"assistant",content:a.content.filter(a=>"text"!==a.type||""!==a.text||null!=a.providerOptions).map(a=>{let b=a.providerOptions;switch(a.type){case"file":{let{data:c,mediaType:d}=bg(a.data);return{type:"file",data:c,filename:a.filename,mediaType:null!=d?d:a.mediaType,providerOptions:b}}case"reasoning":return{type:"reasoning",text:a.text,providerOptions:b};case"text":return{type:"text",text:a.text,providerOptions:b};case"tool-call":return{type:"tool-call",toolCallId:a.toolCallId,toolName:a.toolName,input:a.input,providerExecuted:a.providerExecuted,providerOptions:b};case"tool-result":return{type:"tool-result",toolCallId:a.toolCallId,toolName:a.toolName,output:a.output,providerOptions:b}}}),providerOptions:a.providerOptions};case"tool":return{role:"tool",content:a.content.map(a=>({type:"tool-result",toolCallId:a.toolCallId,toolName:a.toolName,output:a.output,providerOptions:a.providerOptions})),providerOptions:a.providerOptions};default:throw new a2({role:c})}})({message:a,downloadedAssets:d}))]}async function bi(a,b,c){let d=a.filter(a=>"user"===a.role).map(a=>a.content).filter(a=>Array.isArray(a)).flat().filter(a=>"image"===a.type||"file"===a.type).map(a=>{var b;let c=null!=(b=a.mediaType)?b:"image"===a.type?"image/*":void 0,d="image"===a.type?a.image:a.data;if("string"==typeof d)try{d=new URL(d)}catch(a){}return{mediaType:c,data:d}}).filter(a=>a.data instanceof URL).map(a=>({url:a.data,isUrlSupportedByModel:null!=a.mediaType&&(0,B.qs)({url:a.data.toString(),mediaType:a.mediaType,supportedUrls:c})}));return Object.fromEntries((await b(d)).map((a,b)=>null==a?null:[d[b].url.toString(),{data:a.data,mediaType:a.mediaType}]).filter(a=>null!=a))}function bj({maxOutputTokens:a,temperature:b,topP:c,topK:d,presencePenalty:e,frequencyPenalty:f,seed:g,stopSequences:h}){if(null!=a){if(!Number.isInteger(a))throw new aE({parameter:"maxOutputTokens",value:a,message:"maxOutputTokens must be an integer"});if(a<1)throw new aE({parameter:"maxOutputTokens",value:a,message:"maxOutputTokens must be >= 1"})}if(null!=b&&"number"!=typeof b)throw new aE({parameter:"temperature",value:b,message:"temperature must be a number"});if(null!=c&&"number"!=typeof c)throw new aE({parameter:"topP",value:c,message:"topP must be a number"});if(null!=d&&"number"!=typeof d)throw new aE({parameter:"topK",value:d,message:"topK must be a number"});if(null!=e&&"number"!=typeof e)throw new aE({parameter:"presencePenalty",value:e,message:"presencePenalty must be a number"});if(null!=f&&"number"!=typeof f)throw new aE({parameter:"frequencyPenalty",value:f,message:"frequencyPenalty must be a number"});if(null!=g&&!Number.isInteger(g))throw new aE({parameter:"seed",value:g,message:"seed must be an integer"});return{maxOutputTokens:a,temperature:b,topP:c,topK:d,presencePenalty:e,frequencyPenalty:f,stopSequences:h,seed:g}}function bk({tools:a,toolChoice:b,activeTools:c}){return null!=a&&Object.keys(a).length>0?{tools:(null!=c?Object.entries(a).filter(([a])=>c.includes(a)):Object.entries(a)).map(([a,b])=>{let c=b.type;switch(c){case void 0:case"dynamic":case"function":return{type:"function",name:a,description:b.description,inputSchema:(0,B.mD)(b.inputSchema).jsonSchema,providerOptions:b.providerOptions};case"provider-defined":return{type:"provider-defined",name:a,id:b.id,args:b.args};default:throw Error(`Unsupported tool type: ${c}`)}}),toolChoice:null==b?{type:"auto"}:"string"==typeof b?{type:b}:{type:"tool",toolName:b.toolName}}:{tools:void 0,toolChoice:void 0}}var bl=D.RZ(()=>D.KC([D.ch(),D.Yj(),D.ai(),D.zM(),D.g1(D.Yj(),bl),D.YO(bl)])),bm=D.g1(D.Yj(),D.g1(D.Yj(),bl)),bn=D.Ik({type:D.eu("text"),text:D.Yj(),providerOptions:bm.optional()}),bo=D.Ik({type:D.eu("image"),image:D.KC([bf,D.Nl(URL)]),mediaType:D.Yj().optional(),providerOptions:bm.optional()}),bp=D.Ik({type:D.eu("file"),data:D.KC([bf,D.Nl(URL)]),filename:D.Yj().optional(),mediaType:D.Yj(),providerOptions:bm.optional()}),bq=D.Ik({type:D.eu("reasoning"),text:D.Yj(),providerOptions:bm.optional()}),br=D.Ik({type:D.eu("tool-call"),toolCallId:D.Yj(),toolName:D.Yj(),input:D.L5(),providerOptions:bm.optional(),providerExecuted:D.zM().optional()}),bs=D.gM("type",[D.Ik({type:D.eu("text"),value:D.Yj()}),D.Ik({type:D.eu("json"),value:bl}),D.Ik({type:D.eu("error-text"),value:D.Yj()}),D.Ik({type:D.eu("error-json"),value:bl}),D.Ik({type:D.eu("content"),value:D.YO(D.KC([D.Ik({type:D.eu("text"),text:D.Yj()}),D.Ik({type:D.eu("media"),data:D.Yj(),mediaType:D.Yj()})]))})]),bt=D.Ik({type:D.eu("tool-result"),toolCallId:D.Yj(),toolName:D.Yj(),output:bs,providerOptions:bm.optional()}),bu=D.Ik({role:D.eu("system"),content:D.Yj(),providerOptions:bm.optional()}),bv=D.Ik({role:D.eu("user"),content:D.KC([D.Yj(),D.YO(D.KC([bn,bo,bp]))]),providerOptions:bm.optional()}),bw=D.Ik({role:D.eu("assistant"),content:D.KC([D.Yj(),D.YO(D.KC([bn,bp,bq,br,bt]))]),providerOptions:bm.optional()}),bx=D.Ik({role:D.eu("tool"),content:D.YO(bt),providerOptions:bm.optional()}),by=D.KC([bu,bv,bw,bx]);async function bz(a){let b;if(null==a.prompt&&null==a.messages)throw new C.M3({prompt:a,message:"prompt or messages must be defined"});if(null!=a.prompt&&null!=a.messages)throw new C.M3({prompt:a,message:"prompt and messages cannot be defined at the same time"});if(null!=a.system&&"string"!=typeof a.system)throw new C.M3({prompt:a,message:"system must be a string"});if(null!=a.prompt&&"string"==typeof a.prompt)b=[{role:"user",content:a.prompt}];else if(null!=a.prompt&&Array.isArray(a.prompt))b=a.prompt;else if(null!=a.messages)b=a.messages;else throw new C.M3({prompt:a,message:"prompt or messages must be defined"});if(0===b.length)throw new C.M3({prompt:a,message:"messages must not be empty"});let c=await (0,B.ZZ)({value:b,schema:D.YO(by)});if(!c.success)throw new C.M3({prompt:a,message:"The messages must be a ModelMessage[]. If you have passed a UIMessage[], you can use convertToModelMessages to convert them.",cause:c.error});return{messages:b,system:a.system}}function bA(a){return I.isInstance(a)||S.isInstance(a)?new C.bD({name:"GatewayError",message:"Vercel AI Gateway access failed. If you want to use AI SDK providers directly, use the providers, e.g. @ai-sdk/openai, or register a different global default provider.",cause:a}):a}function bB({operationId:a,telemetry:b}){return{"operation.name":`${a}${(null==b?void 0:b.functionId)!=null?` ${b.functionId}`:""}`,"resource.name":null==b?void 0:b.functionId,"ai.operationId":a,"ai.telemetry.functionId":null==b?void 0:b.functionId}}function bC({model:a,settings:b,telemetry:c,headers:d}){var e;return{"ai.model.provider":a.provider,"ai.model.id":a.modelId,...Object.entries(b).reduce((a,[b,c])=>(a[`ai.settings.${b}`]=c,a),{}),...Object.entries(null!=(e=null==c?void 0:c.metadata)?e:{}).reduce((a,[b,c])=>(a[`ai.telemetry.metadata.${b}`]=c,a),{}),...Object.entries(null!=d?d:{}).reduce((a,[b,c])=>(void 0!==c&&(a[`ai.request.headers.${b}`]=c),a),{})}}var bD={startSpan:()=>bE,startActiveSpan:(a,b,c,d)=>"function"==typeof b?b(bE):"function"==typeof c?c(bE):"function"==typeof d?d(bE):void 0},bE={spanContext:()=>bF,setAttribute(){return this},setAttributes(){return this},addEvent(){return this},addLink(){return this},addLinks(){return this},setStatus(){return this},updateName(){return this},end(){return this},isRecording:()=>!1,recordException(){return this}},bF={traceId:"",spanId:"",traceFlags:0};function bG({isEnabled:a=!1,tracer:b}={}){return a?b||as.u.getTracer("ai"):bD}function bH({name:a,tracer:b,attributes:c,fn:d,endWhenDone:e=!0}){return b.startActiveSpan(a,{attributes:c},async a=>{try{let b=await d(a);return e&&a.end(),b}catch(b){try{bI(a,b)}finally{a.end()}throw b}})}function bI(a,b){b instanceof Error?(a.recordException({name:b.name,message:b.message,stack:b.stack}),a.setStatus({code:at.s.ERROR,message:b.message})):a.setStatus({code:at.s.ERROR})}function bJ({telemetry:a,attributes:b}){return(null==a?void 0:a.isEnabled)!==!0?{}:Object.entries(b).reduce((b,[c,d])=>{if(null==d)return b;if("object"==typeof d&&"input"in d&&"function"==typeof d.input){if((null==a?void 0:a.recordInputs)===!1)return b;let e=d.input();return null==e?b:{...b,[c]:e}}if("object"==typeof d&&"output"in d&&"function"==typeof d.output){if((null==a?void 0:a.recordOutputs)===!1)return b;let e=d.output();return null==e?b:{...b,[c]:e}}return{...b,[c]:d}},{})}function bK(a){return JSON.stringify(a.map(a=>({...a,content:"string"==typeof a.content?a.content:a.content.map(a=>{var b;return"file"===a.type?{...a,data:a.data instanceof Uint8Array?"string"==typeof(b=a.data)?b:b instanceof ArrayBuffer?(0,B.n_)(new Uint8Array(b)):(0,B.n_)(b):a.data}:a})})))}function bL(a,b){return{inputTokens:bM(a.inputTokens,b.inputTokens),outputTokens:bM(a.outputTokens,b.outputTokens),totalTokens:bM(a.totalTokens,b.totalTokens),reasoningTokens:bM(a.reasoningTokens,b.reasoningTokens),cachedInputTokens:bM(a.cachedInputTokens,b.cachedInputTokens)}}function bM(a,b){return null==a&&null==b?void 0:(null!=a?a:0)+(null!=b?b:0)}function bN(a){return void 0===a?[]:Array.isArray(a)?a:[a]}async function bO(a,{maxRetries:b,delayInMs:c,backoffFactor:d,abortSignal:e},f=[]){try{return await a()}catch(j){if((0,B.zf)(j)||0===b)throw j;let g=(0,B.u1)(j),h=[...f,j],i=h.length;if(i>b)throw new ba({message:`Failed after ${i} attempts. Last error: ${g}`,reason:"maxRetriesExceeded",errors:h});if(j instanceof Error&&C.hL.isInstance(j)&&!0===j.isRetryable&&i<=b)return await (0,B.cb)(function({error:a,exponentialBackoffDelay:b}){let c,d=a.responseHeaders;if(!d)return b;let e=d["retry-after-ms"];if(e){let a=parseFloat(e);Number.isNaN(a)||(c=a)}let f=d["retry-after"];if(f&&void 0===c){let a=parseFloat(f);c=Number.isNaN(a)?Date.parse(f)-Date.now():1e3*a}return null!=c&&!Number.isNaN(c)&&0<=c&&(c<6e4||c<b)?c:b}({error:j,exponentialBackoffDelay:c}),{abortSignal:e}),bO(a,{maxRetries:b,delayInMs:d*c,backoffFactor:d,abortSignal:e},h);if(1===i)throw j;throw new ba({message:`Failed after ${i} attempts with non-retryable error: '${g}'`,reason:"errorNotRetryable",errors:h})}}function bP({maxRetries:a,abortSignal:b}){if(null!=a){if(!Number.isInteger(a))throw new aE({parameter:"maxRetries",value:a,message:"maxRetries must be an integer"});if(a<0)throw new aE({parameter:"maxRetries",value:a,message:"maxRetries must be >= 0"})}let c=null!=a?a:2;return{maxRetries:c,retry:(({maxRetries:a=2,initialDelayInMs:b=2e3,backoffFactor:c=2,abortSignal:d}={})=>async e=>bO(e,{maxRetries:a,delayInMs:b,backoffFactor:c,abortSignal:d}))({maxRetries:c,abortSignal:b})}}function bQ(a){let b=a.filter(a=>"text"===a.type);if(0!==b.length)return b.map(a=>a.text).join("")}var bR=class{constructor({data:a,mediaType:b}){let c=a instanceof Uint8Array;this.base64Data=c?void 0:a,this.uint8ArrayData=c?a:void 0,this.mediaType=b}get base64(){return null==this.base64Data&&(this.base64Data=(0,B.n_)(this.uint8ArrayData)),this.base64Data}get uint8Array(){return null==this.uint8ArrayData&&(this.uint8ArrayData=(0,B.Z9)(this.base64Data)),this.uint8ArrayData}},bS=class extends bR{constructor(a){super(a),this.type="file"}};async function bT({toolCall:a,tools:b,repairToolCall:c,system:d,messages:e}){try{if(null==b)throw new aU({toolName:a.toolName});try{return await bU({toolCall:a,tools:b})}catch(g){if(null==c||!(aU.isInstance(g)||aI.isInstance(g)))throw g;let f=null;try{f=await c({toolCall:a,tools:b,inputSchema:({toolName:a})=>{let{inputSchema:c}=b[a];return(0,B.mD)(c).jsonSchema},system:d,messages:e,error:g})}catch(a){throw new aY({cause:a,originalError:g})}if(null==f)throw g;return await bU({toolCall:f,tools:b})}}catch(d){let b=await (0,B.N8)({text:a.input}),c=b.success?b.value:a.input;return{type:"tool-call",toolCallId:a.toolCallId,toolName:a.toolName,input:c,dynamic:!0,invalid:!0,error:d}}}async function bU({toolCall:a,tools:b}){let c=a.toolName,d=b[c];if(null==d)throw new aU({toolName:a.toolName,availableTools:Object.keys(b)});let e=(0,B.mD)(d.inputSchema),f=""===a.input.trim()?await (0,B.ZZ)({value:{},schema:e}):await (0,B.N8)({text:a.input,schema:e});if(!1===f.success)throw new aI({toolName:c,toolInput:a.input,cause:f.error});return"dynamic"===d.type?{type:"tool-call",toolCallId:a.toolCallId,toolName:a.toolName,input:f.value,providerExecuted:a.providerExecuted,providerMetadata:a.providerMetadata,dynamic:!0}:{type:"tool-call",toolCallId:a.toolCallId,toolName:c,input:f.value,providerExecuted:a.providerExecuted,providerMetadata:a.providerMetadata}}var bV=class{constructor({content:a,finishReason:b,usage:c,warnings:d,request:e,response:f,providerMetadata:g}){this.content=a,this.finishReason=b,this.usage=c,this.warnings=d,this.request=e,this.response=f,this.providerMetadata=g}get text(){return this.content.filter(a=>"text"===a.type).map(a=>a.text).join("")}get reasoning(){return this.content.filter(a=>"reasoning"===a.type)}get reasoningText(){return 0===this.reasoning.length?void 0:this.reasoning.map(a=>a.text).join("")}get files(){return this.content.filter(a=>"file"===a.type).map(a=>a.file)}get sources(){return this.content.filter(a=>"source"===a.type)}get toolCalls(){return this.content.filter(a=>"tool-call"===a.type)}get staticToolCalls(){return this.toolCalls.filter(a=>!0!==a.dynamic)}get dynamicToolCalls(){return this.toolCalls.filter(a=>!0===a.dynamic)}get toolResults(){return this.content.filter(a=>"tool-result"===a.type)}get staticToolResults(){return this.toolResults.filter(a=>!0!==a.dynamic)}get dynamicToolResults(){return this.toolResults.filter(a=>!0===a.dynamic)}};function bW(a){return({steps:b})=>b.length===a}async function bX({stopConditions:a,steps:b}){return(await Promise.all(a.map(a=>a({steps:b})))).some(a=>a)}function bY({output:a,tool:b,errorMode:c}){return"text"===c?{type:"error-text",value:(0,C.u1)(a)}:"json"===c?{type:"error-json",value:bZ(a)}:(null==b?void 0:b.toModelOutput)?b.toModelOutput(a):"string"==typeof a?{type:"text",value:a}:{type:"json",value:bZ(a)}}function bZ(a){return void 0===a?null:a}function b$({content:a,tools:b}){let c=[],d=a.filter(a=>"source"!==a.type).filter(a=>("tool-result"!==a.type||a.providerExecuted)&&("tool-error"!==a.type||a.providerExecuted)).filter(a=>"text"!==a.type||a.text.length>0).map(a=>{switch(a.type){case"text":return{type:"text",text:a.text,providerOptions:a.providerMetadata};case"reasoning":return{type:"reasoning",text:a.text,providerOptions:a.providerMetadata};case"file":return{type:"file",data:a.file.base64,mediaType:a.file.mediaType,providerOptions:a.providerMetadata};case"tool-call":return{type:"tool-call",toolCallId:a.toolCallId,toolName:a.toolName,input:a.input,providerExecuted:a.providerExecuted,providerOptions:a.providerMetadata};case"tool-result":return{type:"tool-result",toolCallId:a.toolCallId,toolName:a.toolName,output:bY({tool:null==b?void 0:b[a.toolName],output:a.output,errorMode:"none"}),providerExecuted:!0,providerOptions:a.providerMetadata};case"tool-error":return{type:"tool-result",toolCallId:a.toolCallId,toolName:a.toolName,output:bY({tool:null==b?void 0:b[a.toolName],output:a.error,errorMode:"json"}),providerOptions:a.providerMetadata}}});d.length>0&&c.push({role:"assistant",content:d});let e=a.filter(a=>"tool-result"===a.type||"tool-error"===a.type).filter(a=>!a.providerExecuted).map(a=>({type:"tool-result",toolCallId:a.toolCallId,toolName:a.toolName,output:bY({tool:null==b?void 0:b[a.toolName],output:"tool-result"===a.type?a.output:a.error,errorMode:"tool-error"===a.type?"text":"none"})}));return e.length>0&&c.push({role:"tool",content:e}),c}var b_=(0,B.hK)({prefix:"aitxt",size:24});async function b0({model:a,tools:b,toolChoice:c,system:d,prompt:e,messages:f,maxRetries:g,abortSignal:h,headers:i,stopWhen:j=bW(1),experimental_output:k,experimental_telemetry:l,providerOptions:m,experimental_activeTools:n,activeTools:o=n,experimental_prepareStep:p,prepareStep:q=p,experimental_repairToolCall:r,experimental_download:s,experimental_context:t,_internal:{generateId:u=b_,currentDate:v=()=>new Date}={},onStepFinish:w,...x}){let y=bb(a),z=bN(j),{maxRetries:A,retry:C}=bP({maxRetries:g,abortSignal:h}),D=bj(x),E=(0,B.WZ)(null!=i?i:{},`ai/${bd}`),F=bC({model:y,telemetry:l,headers:E,settings:{...D,maxRetries:A}}),G=await bz({system:d,prompt:e,messages:f}),H=bG(l);try{return await bH({name:"ai.generateText",attributes:bJ({telemetry:l,attributes:{...bB({operationId:"ai.generateText",telemetry:l}),...F,"ai.model.provider":y.provider,"ai.model.id":y.modelId,"ai.prompt":{input:()=>JSON.stringify({system:d,prompt:e,messages:f})}}}),tracer:H,fn:async a=>{var e,f,g,i,j,n,p;let A,D=bj(x),I=[],J=[],K=[],L=[];do{let a=[...G.messages,...K],z=await (null==q?void 0:q({model:y,steps:L,stepNumber:L.length,messages:a})),M=await bh({prompt:{system:null!=(e=null==z?void 0:z.system)?e:G.system,messages:null!=(f=null==z?void 0:z.messages)?f:a},supportedUrls:await y.supportedUrls,download:s}),N=bb(null!=(g=null==z?void 0:z.model)?g:y),{toolChoice:O,tools:P}=bk({tools:b,toolChoice:null!=(i=null==z?void 0:z.toolChoice)?i:c,activeTools:null!=(j=null==z?void 0:z.activeTools)?j:o});A=await C(()=>{var a;return bH({name:"ai.generateText.doGenerate",attributes:bJ({telemetry:l,attributes:{...bB({operationId:"ai.generateText.doGenerate",telemetry:l}),...F,"ai.model.provider":N.provider,"ai.model.id":N.modelId,"ai.prompt.messages":{input:()=>bK(M)},"ai.prompt.tools":{input:()=>null==P?void 0:P.map(a=>JSON.stringify(a))},"ai.prompt.toolChoice":{input:()=>null!=O?JSON.stringify(O):void 0},"gen_ai.system":N.provider,"gen_ai.request.model":N.modelId,"gen_ai.request.frequency_penalty":x.frequencyPenalty,"gen_ai.request.max_tokens":x.maxOutputTokens,"gen_ai.request.presence_penalty":x.presencePenalty,"gen_ai.request.stop_sequences":x.stopSequences,"gen_ai.request.temperature":null!=(a=x.temperature)?a:void 0,"gen_ai.request.top_k":x.topK,"gen_ai.request.top_p":x.topP}}),tracer:H,fn:async a=>{var b,c,d,e,f,g,i,j;let n=await N.doGenerate({...D,tools:P,toolChoice:O,responseFormat:null==k?void 0:k.responseFormat,prompt:M,providerOptions:m,abortSignal:h,headers:E}),o={id:null!=(c=null==(b=n.response)?void 0:b.id)?c:u(),timestamp:null!=(e=null==(d=n.response)?void 0:d.timestamp)?e:v(),modelId:null!=(g=null==(f=n.response)?void 0:f.modelId)?g:N.modelId,headers:null==(i=n.response)?void 0:i.headers,body:null==(j=n.response)?void 0:j.body};return a.setAttributes(bJ({telemetry:l,attributes:{"ai.response.finishReason":n.finishReason,"ai.response.text":{output:()=>bQ(n.content)},"ai.response.toolCalls":{output:()=>{let a=b3(n.content);return null==a?void 0:JSON.stringify(a)}},"ai.response.id":o.id,"ai.response.model":o.modelId,"ai.response.timestamp":o.timestamp.toISOString(),"ai.response.providerMetadata":JSON.stringify(n.providerMetadata),"ai.usage.promptTokens":n.usage.inputTokens,"ai.usage.completionTokens":n.usage.outputTokens,"gen_ai.response.finish_reasons":[n.finishReason],"gen_ai.response.id":o.id,"gen_ai.response.model":o.modelId,"gen_ai.usage.input_tokens":n.usage.inputTokens,"gen_ai.usage.output_tokens":n.usage.outputTokens}})),{...n,response:o}}})});let Q=await Promise.all(A.content.filter(a=>"tool-call"===a.type).map(c=>bT({toolCall:c,tools:b,repairToolCall:r,system:d,messages:a})));for(let c of Q){if(c.invalid)continue;let d=b[c.toolName];(null==d?void 0:d.onInputAvailable)!=null&&await d.onInputAvailable({input:c.input,toolCallId:c.toolCallId,messages:a,abortSignal:h,experimental_context:t})}let R=Q.filter(a=>a.invalid&&a.dynamic);for(let a of(J=[],R))J.push({type:"tool-error",toolCallId:a.toolCallId,toolName:a.toolName,input:a.input,error:(0,B.u1)(a.error),dynamic:!0});I=Q.filter(a=>!a.providerExecuted),null!=b&&J.push(...await b1({toolCalls:I.filter(a=>!a.invalid),tools:b,tracer:H,telemetry:l,messages:a,abortSignal:h,experimental_context:t}));let S=function({content:a,toolCalls:b,toolOutputs:c}){return[...a.map(a=>{switch(a.type){case"text":case"reasoning":case"source":return a;case"file":return{type:"file",file:new bR(a)};case"tool-call":return b.find(b=>b.toolCallId===a.toolCallId);case"tool-result":{let c=b.find(b=>b.toolCallId===a.toolCallId);if(null==c)throw Error(`Tool call ${a.toolCallId} not found.`);if(a.isError)return{type:"tool-error",toolCallId:a.toolCallId,toolName:a.toolName,input:c.input,error:a.result,providerExecuted:!0,dynamic:c.dynamic};return{type:"tool-result",toolCallId:a.toolCallId,toolName:a.toolName,input:c.input,output:a.result,providerExecuted:!0,dynamic:c.dynamic}}}}),...c]}({content:A.content,toolCalls:Q,toolOutputs:J});K.push(...b$({content:S,tools:b}));let T=new bV({content:S,finishReason:A.finishReason,usage:A.usage,warnings:A.warnings,providerMetadata:A.providerMetadata,request:null!=(n=A.request)?n:{},response:{...A.response,messages:structuredClone(K)}});aA(null!=(p=A.warnings)?p:[]),L.push(T),await (null==w?void 0:w(T))}while(I.length>0&&J.length===I.length&&!await bX({stopConditions:z,steps:L}));a.setAttributes(bJ({telemetry:l,attributes:{"ai.response.finishReason":A.finishReason,"ai.response.text":{output:()=>bQ(A.content)},"ai.response.toolCalls":{output:()=>{let a=b3(A.content);return null==a?void 0:JSON.stringify(a)}},"ai.response.providerMetadata":JSON.stringify(A.providerMetadata),"ai.usage.promptTokens":A.usage.inputTokens,"ai.usage.completionTokens":A.usage.outputTokens}}));let M=L[L.length-1];return new b2({steps:L,resolvedOutput:await (null==k?void 0:k.parseOutput({text:M.text},{response:M.response,usage:M.usage,finishReason:M.finishReason}))})}})}catch(a){throw bA(a)}}async function b1({toolCalls:a,tools:b,tracer:c,telemetry:d,messages:e,abortSignal:f,experimental_context:g}){return(await Promise.all(a.map(async({toolCallId:a,toolName:h,input:i})=>{let j=b[h];if((null==j?void 0:j.execute)!=null)return bH({name:"ai.toolCall",attributes:bJ({telemetry:d,attributes:{...bB({operationId:"ai.toolCall",telemetry:d}),"ai.toolCall.name":h,"ai.toolCall.id":a,"ai.toolCall.args":{output:()=>JSON.stringify(i)}}}),tracer:c,fn:async b=>{try{let c;for await(let b of(0,B.o8)({execute:j.execute.bind(j),input:i,options:{toolCallId:a,messages:e,abortSignal:f,experimental_context:g}}))"final"===b.type&&(c=b.output);try{b.setAttributes(bJ({telemetry:d,attributes:{"ai.toolCall.result":{output:()=>JSON.stringify(c)}}}))}catch(a){}return{type:"tool-result",toolCallId:a,toolName:h,input:i,output:c,dynamic:"dynamic"===j.type}}catch(c){return bI(b,c),{type:"tool-error",toolCallId:a,toolName:h,input:i,error:c,dynamic:"dynamic"===j.type}}}})}))).filter(a=>null!=a)}var b2=class{constructor(a){this.steps=a.steps,this.resolvedOutput=a.resolvedOutput}get finalStep(){return this.steps[this.steps.length-1]}get content(){return this.finalStep.content}get text(){return this.finalStep.text}get files(){return this.finalStep.files}get reasoningText(){return this.finalStep.reasoningText}get reasoning(){return this.finalStep.reasoning}get toolCalls(){return this.finalStep.toolCalls}get staticToolCalls(){return this.finalStep.staticToolCalls}get dynamicToolCalls(){return this.finalStep.dynamicToolCalls}get toolResults(){return this.finalStep.toolResults}get staticToolResults(){return this.finalStep.staticToolResults}get dynamicToolResults(){return this.finalStep.dynamicToolResults}get sources(){return this.finalStep.sources}get finishReason(){return this.finalStep.finishReason}get warnings(){return this.finalStep.warnings}get providerMetadata(){return this.finalStep.providerMetadata}get response(){return this.finalStep.response}get request(){return this.finalStep.request}get usage(){return this.finalStep.usage}get totalUsage(){return this.steps.reduce((a,b)=>bL(a,b.usage),{inputTokens:void 0,outputTokens:void 0,totalTokens:void 0,reasoningTokens:void 0,cachedInputTokens:void 0})}get experimental_output(){if(null==this.resolvedOutput)throw new ay;return this.resolvedOutput}};function b3(a){let b=a.filter(a=>"tool-call"===a.type);if(0!==b.length)return b.map(a=>({toolCallId:a.toolCallId,toolName:a.toolName,input:a.input}))}function b4(a,b){let c=new Headers(null!=a?a:{});for(let[a,d]of Object.entries(b))c.has(a)||c.set(a,d);return c}function b5({response:a,status:b,statusText:c,headers:d,stream:e}){a.writeHead(null!=b?b:200,c,d);let f=e.getReader();(async()=>{try{for(;;){let{done:b,value:c}=await f.read();if(b)break;a.write(c)}}catch(a){throw a}finally{a.end()}})()}var b6=class extends TransformStream{constructor(){super({transform(a,b){b.enqueue(`data: ${JSON.stringify(a)}

`)},flush(a){a.enqueue("data: [DONE]\n\n")}})}},b7={"content-type":"text/event-stream","cache-control":"no-cache",connection:"keep-alive","x-vercel-ai-ui-message-stream":"v1","x-accel-buffering":"no"};async function b8(a){if(void 0===a)return{value:void 0,state:"undefined-input"};let b=await (0,B.N8)({text:a});return b.success?{value:b.value,state:"successful-parse"}:(b=await (0,B.N8)({text:function(a){let b=["ROOT"],c=-1,d=null;function e(a,e,f){switch(a){case'"':c=e,b.pop(),b.push(f),b.push("INSIDE_STRING");break;case"f":case"t":case"n":c=e,d=e,b.pop(),b.push(f),b.push("INSIDE_LITERAL");break;case"-":b.pop(),b.push(f),b.push("INSIDE_NUMBER");break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":c=e,b.pop(),b.push(f),b.push("INSIDE_NUMBER");break;case"{":c=e,b.pop(),b.push(f),b.push("INSIDE_OBJECT_START");break;case"[":c=e,b.pop(),b.push(f),b.push("INSIDE_ARRAY_START")}}function f(a,d){switch(a){case",":b.pop(),b.push("INSIDE_OBJECT_AFTER_COMMA");break;case"}":c=d,b.pop()}}function g(a,d){switch(a){case",":b.pop(),b.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":c=d,b.pop()}}for(let h=0;h<a.length;h++){let i=a[h];switch(b[b.length-1]){case"ROOT":e(i,h,"FINISH");break;case"INSIDE_OBJECT_START":switch(i){case'"':b.pop(),b.push("INSIDE_OBJECT_KEY");break;case"}":c=h,b.pop()}break;case"INSIDE_OBJECT_AFTER_COMMA":'"'===i&&(b.pop(),b.push("INSIDE_OBJECT_KEY"));break;case"INSIDE_OBJECT_KEY":'"'===i&&(b.pop(),b.push("INSIDE_OBJECT_AFTER_KEY"));break;case"INSIDE_OBJECT_AFTER_KEY":":"===i&&(b.pop(),b.push("INSIDE_OBJECT_BEFORE_VALUE"));break;case"INSIDE_OBJECT_BEFORE_VALUE":e(i,h,"INSIDE_OBJECT_AFTER_VALUE");break;case"INSIDE_OBJECT_AFTER_VALUE":f(i,h);break;case"INSIDE_STRING":switch(i){case'"':b.pop(),c=h;break;case"\\":b.push("INSIDE_STRING_ESCAPE");break;default:c=h}break;case"INSIDE_ARRAY_START":"]"===i?(c=h,b.pop()):(c=h,e(i,h,"INSIDE_ARRAY_AFTER_VALUE"));break;case"INSIDE_ARRAY_AFTER_VALUE":switch(i){case",":b.pop(),b.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":c=h,b.pop();break;default:c=h}break;case"INSIDE_ARRAY_AFTER_COMMA":e(i,h,"INSIDE_ARRAY_AFTER_VALUE");break;case"INSIDE_STRING_ESCAPE":b.pop(),c=h;break;case"INSIDE_NUMBER":switch(i){case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":c=h;break;case"e":case"E":case"-":case".":break;case",":b.pop(),"INSIDE_ARRAY_AFTER_VALUE"===b[b.length-1]&&g(i,h),"INSIDE_OBJECT_AFTER_VALUE"===b[b.length-1]&&f(i,h);break;case"}":b.pop(),"INSIDE_OBJECT_AFTER_VALUE"===b[b.length-1]&&f(i,h);break;case"]":b.pop(),"INSIDE_ARRAY_AFTER_VALUE"===b[b.length-1]&&g(i,h);break;default:b.pop()}break;case"INSIDE_LITERAL":{let e=a.substring(d,h+1);"false".startsWith(e)||"true".startsWith(e)||"null".startsWith(e)?c=h:(b.pop(),"INSIDE_OBJECT_AFTER_VALUE"===b[b.length-1]?f(i,h):"INSIDE_ARRAY_AFTER_VALUE"===b[b.length-1]&&g(i,h))}}}let h=a.slice(0,c+1);for(let c=b.length-1;c>=0;c--)switch(b[c]){case"INSIDE_STRING":h+='"';break;case"INSIDE_OBJECT_KEY":case"INSIDE_OBJECT_AFTER_KEY":case"INSIDE_OBJECT_AFTER_COMMA":case"INSIDE_OBJECT_START":case"INSIDE_OBJECT_BEFORE_VALUE":case"INSIDE_OBJECT_AFTER_VALUE":h+="}";break;case"INSIDE_ARRAY_START":case"INSIDE_ARRAY_AFTER_COMMA":case"INSIDE_ARRAY_AFTER_VALUE":h+="]";break;case"INSIDE_LITERAL":{let b=a.substring(d,a.length);"true".startsWith(b)?h+="true".slice(b.length):"false".startsWith(b)?h+="false".slice(b.length):"null".startsWith(b)&&(h+="null".slice(b.length))}}return h}(a)})).success?{value:b.value,state:"repaired-parse"}:{value:void 0,state:"failed-parse"}}function b9(a){return a.type.startsWith("tool-")}function ca(a){return a.type.split("-").slice(1).join("-")}function cb(a){let b=a.pipeThrough(new TransformStream);return b[Symbol.asyncIterator]=function(){let a=this.getReader(),b=!1;async function c(c){var d;b=!0;try{c&&await (null==(d=a.cancel)?void 0:d.call(a))}finally{try{a.releaseLock()}catch(a){}}}return{async next(){if(b)return{done:!0,value:void 0};let{done:d,value:e}=await a.read();return d?(await c(!0),{done:!0,value:void 0}):{done:!1,value:e}},return:async()=>(await c(!0),{done:!0,value:void 0}),async throw(a){throw await c(!0),a}}},b}async function cc({stream:a,onError:b}){let c=a.getReader();try{for(;;){let{done:a}=await c.read();if(a)break}}catch(a){null==b||b(a)}finally{c.releaseLock()}}function cd(){let a,b;return{promise:new Promise((c,d)=>{a=c,b=d}),resolve:a,reject:b}}D.KC([D.re({type:D.eu("text-start"),id:D.Yj(),providerMetadata:bm.optional()}),D.re({type:D.eu("text-delta"),id:D.Yj(),delta:D.Yj(),providerMetadata:bm.optional()}),D.re({type:D.eu("text-end"),id:D.Yj(),providerMetadata:bm.optional()}),D.re({type:D.eu("error"),errorText:D.Yj()}),D.re({type:D.eu("tool-input-start"),toolCallId:D.Yj(),toolName:D.Yj(),providerExecuted:D.zM().optional(),dynamic:D.zM().optional()}),D.re({type:D.eu("tool-input-delta"),toolCallId:D.Yj(),inputTextDelta:D.Yj()}),D.re({type:D.eu("tool-input-available"),toolCallId:D.Yj(),toolName:D.Yj(),input:D.L5(),providerExecuted:D.zM().optional(),providerMetadata:bm.optional(),dynamic:D.zM().optional()}),D.re({type:D.eu("tool-input-error"),toolCallId:D.Yj(),toolName:D.Yj(),input:D.L5(),providerExecuted:D.zM().optional(),providerMetadata:bm.optional(),dynamic:D.zM().optional(),errorText:D.Yj()}),D.re({type:D.eu("tool-output-available"),toolCallId:D.Yj(),output:D.L5(),providerExecuted:D.zM().optional(),dynamic:D.zM().optional(),preliminary:D.zM().optional()}),D.re({type:D.eu("tool-output-error"),toolCallId:D.Yj(),errorText:D.Yj(),providerExecuted:D.zM().optional(),dynamic:D.zM().optional()}),D.re({type:D.eu("reasoning-start"),id:D.Yj(),providerMetadata:bm.optional()}),D.re({type:D.eu("reasoning-delta"),id:D.Yj(),delta:D.Yj(),providerMetadata:bm.optional()}),D.re({type:D.eu("reasoning-end"),id:D.Yj(),providerMetadata:bm.optional()}),D.re({type:D.eu("source-url"),sourceId:D.Yj(),url:D.Yj(),title:D.Yj().optional(),providerMetadata:bm.optional()}),D.re({type:D.eu("source-document"),sourceId:D.Yj(),mediaType:D.Yj(),title:D.Yj(),filename:D.Yj().optional(),providerMetadata:bm.optional()}),D.re({type:D.eu("file"),url:D.Yj(),mediaType:D.Yj(),providerMetadata:bm.optional()}),D.re({type:D.Ie(a=>"string"==typeof a&&a.startsWith("data-"),{message:'Type must start with "data-"'}),id:D.Yj().optional(),data:D.L5(),transient:D.zM().optional()}),D.re({type:D.eu("start-step")}),D.re({type:D.eu("finish-step")}),D.re({type:D.eu("start"),messageId:D.Yj().optional(),messageMetadata:D.L5().optional()}),D.re({type:D.eu("finish"),messageMetadata:D.L5().optional()}),D.re({type:D.eu("abort")}),D.re({type:D.eu("message-metadata"),messageMetadata:D.L5()})]);var ce=class{constructor(){this.status={type:"pending"},this._resolve=void 0,this._reject=void 0}get promise(){return this._promise||(this._promise=new Promise((a,b)=>{"resolved"===this.status.type?a(this.status.value):"rejected"===this.status.type&&b(this.status.error),this._resolve=a,this._reject=b})),this._promise}resolve(a){var b;this.status={type:"resolved",value:a},this._promise&&(null==(b=this._resolve)||b.call(this,a))}reject(a){var b;this.status={type:"rejected",error:a},this._promise&&(null==(b=this._reject)||b.call(this,a))}};function cf(){var a,b;return null!=(b=null==(a=null==globalThis?void 0:globalThis.performance)?void 0:a.now())?b:Date.now()}var cg=(0,B.hK)({prefix:"aitxt",size:24});function ch({model:a,tools:b,toolChoice:c,system:d,prompt:e,messages:f,maxRetries:g,abortSignal:h,headers:i,stopWhen:j=bW(1),experimental_output:k,experimental_telemetry:l,prepareStep:m,providerOptions:n,experimental_activeTools:o,activeTools:p=o,experimental_repairToolCall:q,experimental_transform:r,experimental_download:s,includeRawChunks:t=!1,onChunk:u,onError:v=({error:a})=>{console.error(a)},onFinish:w,onAbort:x,onStepFinish:y,experimental_context:z,_internal:{now:A=cf,generateId:B=cg,currentDate:C=()=>new Date}={},...D}){return new ci({model:bb(a),telemetry:l,headers:i,settings:D,maxRetries:g,abortSignal:h,system:d,prompt:e,messages:f,tools:b,toolChoice:c,transforms:bN(r),activeTools:p,repairToolCall:q,stopConditions:bN(j),output:k,providerOptions:n,prepareStep:m,includeRawChunks:t,onChunk:u,onError:v,onFinish:w,onAbort:x,onStepFinish:y,now:A,currentDate:C,generateId:B,experimental_context:z,download:s})}var ci=class{constructor({model:a,telemetry:b,headers:c,settings:d,maxRetries:e,abortSignal:f,system:g,prompt:h,messages:i,tools:j,toolChoice:k,transforms:l,activeTools:m,repairToolCall:n,stopConditions:o,output:p,providerOptions:q,prepareStep:r,includeRawChunks:s,now:t,currentDate:u,generateId:v,onChunk:w,onError:x,onFinish:y,onAbort:z,onStepFinish:A,experimental_context:C,download:D}){let E,F,G,H;this._totalUsage=new ce,this._finishReason=new ce,this._steps=new ce,this.output=p,this.includeRawChunks=s,this.tools=j;let I=[],J=[],K={},L=[],M=[],N={},O={},P=new TransformStream({async transform(a,b){var c,d,e;b.enqueue(a);let{part:f}=a;if(("text-delta"===f.type||"reasoning-delta"===f.type||"source"===f.type||"tool-call"===f.type||"tool-result"===f.type||"tool-input-start"===f.type||"tool-input-delta"===f.type||"raw"===f.type)&&await (null==w?void 0:w({chunk:f})),"error"===f.type&&await x({error:bA(f.error)}),"text-start"===f.type&&(N[f.id]={type:"text",text:"",providerMetadata:f.providerMetadata},I.push(N[f.id])),"text-delta"===f.type){let a=N[f.id];if(null==a)return void b.enqueue({part:{type:"error",error:`text part ${f.id} not found`},partialOutput:void 0});a.text+=f.text,a.providerMetadata=null!=(c=f.providerMetadata)?c:a.providerMetadata}if("text-end"===f.type&&delete N[f.id],"reasoning-start"===f.type&&(O[f.id]={type:"reasoning",text:"",providerMetadata:f.providerMetadata},I.push(O[f.id])),"reasoning-delta"===f.type){let a=O[f.id];if(null==a)return void b.enqueue({part:{type:"error",error:`reasoning part ${f.id} not found`},partialOutput:void 0});a.text+=f.text,a.providerMetadata=null!=(d=f.providerMetadata)?d:a.providerMetadata}if("reasoning-end"===f.type){let a=O[f.id];if(null==a)return void b.enqueue({part:{type:"error",error:`reasoning part ${f.id} not found`},partialOutput:void 0});a.providerMetadata=null!=(e=f.providerMetadata)?e:a.providerMetadata,delete O[f.id]}if("file"===f.type&&I.push({type:"file",file:f.file}),"source"===f.type&&I.push(f),"tool-call"===f.type&&I.push(f),"tool-result"!==f.type||f.preliminary||I.push(f),"tool-error"===f.type&&I.push(f),"start-step"===f.type&&(K=f.request,L=f.warnings),"finish-step"===f.type){let a=b$({content:I,tools:j}),b=new bV({content:I,finishReason:f.finishReason,usage:f.usage,warnings:L,request:K,response:{...f.response,messages:[...J,...a]},providerMetadata:f.providerMetadata});await (null==A?void 0:A(b)),aA(L),M.push(b),I=[],O={},N={},J.push(...a),E.resolve()}"finish"===f.type&&(H=f.totalUsage,G=f.finishReason)},async flush(a){try{if(0===M.length){let a=new aQ({message:"No output generated. Check the stream for errors."});Y._finishReason.reject(a),Y._totalUsage.reject(a),Y._steps.reject(a);return}let a=null!=G?G:"unknown",c=null!=H?H:{inputTokens:void 0,outputTokens:void 0,totalTokens:void 0};Y._finishReason.resolve(a),Y._totalUsage.resolve(c),Y._steps.resolve(M);let d=M[M.length-1];await (null==y?void 0:y({finishReason:a,totalUsage:c,usage:d.usage,content:d.content,text:d.text,reasoningText:d.reasoningText,reasoning:d.reasoning,files:d.files,sources:d.sources,toolCalls:d.toolCalls,staticToolCalls:d.staticToolCalls,dynamicToolCalls:d.dynamicToolCalls,toolResults:d.toolResults,staticToolResults:d.staticToolResults,dynamicToolResults:d.dynamicToolResults,request:d.request,response:d.response,warnings:d.warnings,providerMetadata:d.providerMetadata,steps:M})),F.setAttributes(bJ({telemetry:b,attributes:{"ai.response.finishReason":a,"ai.response.text":{output:()=>d.text},"ai.response.toolCalls":{output:()=>{var a;return(null==(a=d.toolCalls)?void 0:a.length)?JSON.stringify(d.toolCalls):void 0}},"ai.response.providerMetadata":JSON.stringify(d.providerMetadata),"ai.usage.inputTokens":c.inputTokens,"ai.usage.outputTokens":c.outputTokens,"ai.usage.totalTokens":c.totalTokens,"ai.usage.reasoningTokens":c.reasoningTokens,"ai.usage.cachedInputTokens":c.cachedInputTokens}}))}catch(b){a.error(b)}finally{F.end()}}}),Q=function(){let a=[],b=null,c=!1,d=cd(),e=()=>{c=!0,d.resolve(),a.forEach(a=>a.cancel()),a=[],null==b||b.close()},f=async()=>{if(c&&0===a.length){null==b||b.close();return}if(0===a.length)return d=cd(),await d.promise,f();try{let{value:d,done:e}=await a[0].read();e?(a.shift(),a.length>0?await f():c&&(null==b||b.close())):null==b||b.enqueue(d)}catch(c){null==b||b.error(c),a.shift(),e()}};return{stream:new ReadableStream({start(a){b=a},pull:f,async cancel(){for(let b of a)await b.cancel();a=[],c=!0}}),addStream:b=>{if(c)throw Error("Cannot add inner stream: outer stream is closed");a.push(b.getReader()),d.resolve()},close:()=>{c=!0,d.resolve(),0===a.length&&(null==b||b.close())},terminate:e}}();this.addStream=Q.addStream,this.closeStream=Q.close;let R=Q.stream.getReader(),S=new ReadableStream({async start(a){a.enqueue({type:"start"})},async pull(a){function b(){null==z||z({steps:M}),a.enqueue({type:"abort"}),a.close()}try{let{done:c,value:d}=await R.read();if(c)return void a.close();if(null==f?void 0:f.aborted)return void b();a.enqueue(d)}catch(c){(0,B.zf)(c)&&(null==f?void 0:f.aborted)?b():a.error(c)}},cancel:a=>Q.stream.cancel(a)});for(let a of l)S=S.pipeThrough(a({tools:j,stopStream(){Q.terminate()}}));this.baseStream=S.pipeThrough(function(a){let b;if(!a)return new TransformStream({transform(a,b){b.enqueue({part:a,partialOutput:void 0})}});let c="",d="",e="";function f({controller:a,partialOutput:c}){a.enqueue({part:{type:"text-delta",id:b,text:d},partialOutput:c}),d=""}return new TransformStream({async transform(g,h){if("finish-step"===g.type&&d.length>0&&f({controller:h}),"text-delta"!==g.type&&"text-start"!==g.type&&"text-end"!==g.type)return void h.enqueue({part:g,partialOutput:void 0});if(null==b)b=g.id;else if(g.id!==b)return void h.enqueue({part:g,partialOutput:void 0});if("text-start"===g.type)return void h.enqueue({part:g,partialOutput:void 0});if("text-end"===g.type){d.length>0&&f({controller:h}),h.enqueue({part:g,partialOutput:void 0});return}c+=g.text,d+=g.text;let i=await a.parsePartial({text:c});if(null!=i){let a=JSON.stringify(i.partial);a!==e&&(f({controller:h,partialOutput:i.partial}),e=a)}}})}(p)).pipeThrough(P);let{maxRetries:T,retry:U}=bP({maxRetries:e,abortSignal:f}),V=bG(b),W=bj(d),X=bC({model:a,telemetry:b,headers:c,settings:{...W,maxRetries:T}}),Y=this;bH({name:"ai.streamText",attributes:bJ({telemetry:b,attributes:{...bB({operationId:"ai.streamText",telemetry:b}),...X,"ai.prompt":{input:()=>JSON.stringify({system:g,prompt:h,messages:i})}}}),tracer:V,endWhenDone:!1,fn:async d=>{async function e({currentStep:d,responseMessages:l,usage:s}){var w,x,y,z,A;let F,G,H=Y.includeRawChunks;E=new ce;let I=await bz({system:g,prompt:h,messages:i}),J=[...I.messages,...l],K=await (null==r?void 0:r({model:a,steps:M,stepNumber:M.length,messages:J})),L=await bh({prompt:{system:null!=(w=null==K?void 0:K.system)?w:I.system,messages:null!=(x=null==K?void 0:K.messages)?x:J},supportedUrls:await a.supportedUrls,download:D}),N=bb(null!=(y=null==K?void 0:K.model)?y:a),{toolChoice:O,tools:P}=bk({tools:j,toolChoice:null!=(z=null==K?void 0:K.toolChoice)?z:k,activeTools:null!=(A=null==K?void 0:K.activeTools)?A:m}),{result:{stream:Q,response:R,request:S},doStreamSpan:T,startTimestampMs:Z}=await U(()=>bH({name:"ai.streamText.doStream",attributes:bJ({telemetry:b,attributes:{...bB({operationId:"ai.streamText.doStream",telemetry:b}),...X,"ai.model.provider":N.provider,"ai.model.id":N.modelId,"ai.prompt.messages":{input:()=>bK(L)},"ai.prompt.tools":{input:()=>null==P?void 0:P.map(a=>JSON.stringify(a))},"ai.prompt.toolChoice":{input:()=>null!=O?JSON.stringify(O):void 0},"gen_ai.system":N.provider,"gen_ai.request.model":N.modelId,"gen_ai.request.frequency_penalty":W.frequencyPenalty,"gen_ai.request.max_tokens":W.maxOutputTokens,"gen_ai.request.presence_penalty":W.presencePenalty,"gen_ai.request.stop_sequences":W.stopSequences,"gen_ai.request.temperature":W.temperature,"gen_ai.request.top_k":W.topK,"gen_ai.request.top_p":W.topP}}),tracer:V,endWhenDone:!1,fn:async a=>({startTimestampMs:t(),doStreamSpan:a,result:await N.doStream({...W,tools:P,toolChoice:O,responseFormat:null==p?void 0:p.responseFormat,prompt:L,providerOptions:q,abortSignal:f,headers:c,includeRawChunks:H})})})),$=function({tools:a,generatorStream:b,tracer:c,telemetry:d,system:e,messages:f,abortSignal:g,repairToolCall:h,experimental_context:i}){let j,k=null,l=new ReadableStream({start(a){k=a}}),m=new Set,n=new Map,o=!1;function p(){o&&0===m.size&&(null!=j&&k.enqueue(j),k.close())}let q=new TransformStream({async transform(b,l){let o=b.type;switch(o){case"stream-start":case"text-start":case"text-delta":case"text-end":case"reasoning-start":case"reasoning-delta":case"reasoning-end":case"tool-input-start":case"tool-input-delta":case"tool-input-end":case"source":case"response-metadata":case"error":case"raw":l.enqueue(b);break;case"file":l.enqueue({type:"file",file:new bS({data:b.data,mediaType:b.mediaType})});break;case"finish":j={type:"finish",finishReason:b.finishReason,usage:b.usage,providerMetadata:b.providerMetadata};break;case"tool-call":try{let j=await bT({toolCall:b,tools:a,repairToolCall:h,system:e,messages:f});if(l.enqueue(j),j.invalid){k.enqueue({type:"tool-error",toolCallId:j.toolCallId,toolName:j.toolName,input:j.input,error:(0,B.u1)(j.error),dynamic:!0});break}let o=a[j.toolName];if(n.set(j.toolCallId,j.input),null!=o.onInputAvailable&&await o.onInputAvailable({input:j.input,toolCallId:j.toolCallId,messages:f,abortSignal:g,experimental_context:i}),null!=o.execute&&!0!==j.providerExecuted){let a=(0,B.$C)();m.add(a),bH({name:"ai.toolCall",attributes:bJ({telemetry:d,attributes:{...bB({operationId:"ai.toolCall",telemetry:d}),"ai.toolCall.name":j.toolName,"ai.toolCall.id":j.toolCallId,"ai.toolCall.args":{output:()=>JSON.stringify(j.input)}}}),tracer:c,fn:async b=>{let c;try{for await(let a of(0,B.o8)({execute:o.execute.bind(o),input:j.input,options:{toolCallId:j.toolCallId,messages:f,abortSignal:g,experimental_context:i}}))k.enqueue({...j,type:"tool-result",output:a.output,..."preliminary"===a.type&&{preliminary:!0}}),"final"===a.type&&(c=a.output)}catch(c){bI(b,c),k.enqueue({...j,type:"tool-error",error:c}),m.delete(a),p();return}m.delete(a),p();try{b.setAttributes(bJ({telemetry:d,attributes:{"ai.toolCall.result":{output:()=>JSON.stringify(c)}}}))}catch(a){}}})}}catch(a){k.enqueue({type:"error",error:a})}break;case"tool-result":{let a=b.toolName;b.isError?k.enqueue({type:"tool-error",toolCallId:b.toolCallId,toolName:a,input:n.get(b.toolCallId),providerExecuted:b.providerExecuted,error:b.result}):l.enqueue({type:"tool-result",toolCallId:b.toolCallId,toolName:a,input:n.get(b.toolCallId),output:b.result,providerExecuted:b.providerExecuted});break}default:throw Error(`Unhandled chunk type: ${o}`)}},flush(){o=!0,p()}});return new ReadableStream({start:async a=>Promise.all([b.pipeThrough(q).pipeTo(new WritableStream({write(b){a.enqueue(b)},close(){}})),l.pipeTo(new WritableStream({write(b){a.enqueue(b)},close(){a.close()}}))])})}({tools:j,generatorStream:Q,tracer:V,telemetry:b,system:g,messages:J,repairToolCall:n,abortSignal:f,experimental_context:C}),_=null!=S?S:{},aa=[],ab=[],ac={},ad="unknown",ae={inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},af=!0,ag={id:v(),timestamp:u(),modelId:a.modelId},ah="";Y.addStream($.pipeThrough(new TransformStream({async transform(a,b){var c,d,e,g;if("stream-start"===a.type){F=a.warnings;return}if(af){let a=t()-Z;af=!1,T.addEvent("ai.stream.firstChunk",{"ai.response.msToFirstChunk":a}),T.setAttributes({"ai.response.msToFirstChunk":a}),b.enqueue({type:"start-step",request:_,warnings:null!=F?F:[]})}let h=a.type;switch(h){case"text-start":case"text-end":case"reasoning-start":case"reasoning-end":case"file":case"source":b.enqueue(a);break;case"text-delta":a.delta.length>0&&(b.enqueue({type:"text-delta",id:a.id,text:a.delta,providerMetadata:a.providerMetadata}),ah+=a.delta);break;case"reasoning-delta":b.enqueue({type:"reasoning-delta",id:a.id,text:a.delta,providerMetadata:a.providerMetadata});break;case"tool-call":b.enqueue(a),aa.push(a);break;case"tool-result":b.enqueue(a),a.preliminary||ab.push(a);break;case"tool-error":b.enqueue(a),ab.push(a);break;case"response-metadata":ag={id:null!=(c=a.id)?c:ag.id,timestamp:null!=(d=a.timestamp)?d:ag.timestamp,modelId:null!=(e=a.modelId)?e:ag.modelId};break;case"finish":{ae=a.usage,ad=a.finishReason,G=a.providerMetadata;let b=t()-Z;T.addEvent("ai.stream.finish"),T.setAttributes({"ai.response.msToFinish":b,"ai.response.avgOutputTokensPerSecond":1e3*(null!=(g=ae.outputTokens)?g:0)/b});break}case"tool-input-start":{ac[a.id]=a.toolName;let c=null==j?void 0:j[a.toolName];(null==c?void 0:c.onInputStart)!=null&&await c.onInputStart({toolCallId:a.id,messages:J,abortSignal:f,experimental_context:C}),b.enqueue({...a,dynamic:(null==c?void 0:c.type)==="dynamic"});break}case"tool-input-end":delete ac[a.id],b.enqueue(a);break;case"tool-input-delta":{let c=ac[a.id],d=null==j?void 0:j[c];(null==d?void 0:d.onInputDelta)!=null&&await d.onInputDelta({inputTextDelta:a.delta,toolCallId:a.id,messages:J,abortSignal:f,experimental_context:C}),b.enqueue(a);break}case"error":b.enqueue(a),ad="error";break;case"raw":H&&b.enqueue(a);break;default:throw Error(`Unknown chunk type: ${h}`)}},async flush(a){let c=aa.length>0?JSON.stringify(aa):void 0;try{T.setAttributes(bJ({telemetry:b,attributes:{"ai.response.finishReason":ad,"ai.response.text":{output:()=>ah},"ai.response.toolCalls":{output:()=>c},"ai.response.id":ag.id,"ai.response.model":ag.modelId,"ai.response.timestamp":ag.timestamp.toISOString(),"ai.response.providerMetadata":JSON.stringify(G),"ai.usage.inputTokens":ae.inputTokens,"ai.usage.outputTokens":ae.outputTokens,"ai.usage.totalTokens":ae.totalTokens,"ai.usage.reasoningTokens":ae.reasoningTokens,"ai.usage.cachedInputTokens":ae.cachedInputTokens,"gen_ai.response.finish_reasons":[ad],"gen_ai.response.id":ag.id,"gen_ai.response.model":ag.modelId,"gen_ai.usage.input_tokens":ae.inputTokens,"gen_ai.usage.output_tokens":ae.outputTokens}}))}catch(a){}finally{T.end()}a.enqueue({type:"finish-step",finishReason:ad,usage:ae,providerMetadata:G,response:{...ag,headers:null==R?void 0:R.headers}});let f=bL(s,ae);await E.promise;let g=aa.filter(a=>!0!==a.providerExecuted),h=ab.filter(a=>!0!==a.providerExecuted);if(g.length>0&&h.length===g.length&&!await bX({stopConditions:o,steps:M})){l.push(...b$({content:M[M.length-1].content,tools:j}));try{await e({currentStep:d+1,responseMessages:l,usage:f})}catch(b){a.enqueue({type:"error",error:b}),Y.closeStream()}}else a.enqueue({type:"finish",finishReason:ad,totalUsage:f}),Y.closeStream()}})))}F=d,await e({currentStep:0,responseMessages:[],usage:{inputTokens:void 0,outputTokens:void 0,totalTokens:void 0}})}}).catch(a=>{Y.addStream(new ReadableStream({start(b){b.enqueue({type:"error",error:a}),b.close()}})),Y.closeStream()})}get steps(){return this.consumeStream(),this._steps.promise}get finalStep(){return this.steps.then(a=>a[a.length-1])}get content(){return this.finalStep.then(a=>a.content)}get warnings(){return this.finalStep.then(a=>a.warnings)}get providerMetadata(){return this.finalStep.then(a=>a.providerMetadata)}get text(){return this.finalStep.then(a=>a.text)}get reasoningText(){return this.finalStep.then(a=>a.reasoningText)}get reasoning(){return this.finalStep.then(a=>a.reasoning)}get sources(){return this.finalStep.then(a=>a.sources)}get files(){return this.finalStep.then(a=>a.files)}get toolCalls(){return this.finalStep.then(a=>a.toolCalls)}get staticToolCalls(){return this.finalStep.then(a=>a.staticToolCalls)}get dynamicToolCalls(){return this.finalStep.then(a=>a.dynamicToolCalls)}get toolResults(){return this.finalStep.then(a=>a.toolResults)}get staticToolResults(){return this.finalStep.then(a=>a.staticToolResults)}get dynamicToolResults(){return this.finalStep.then(a=>a.dynamicToolResults)}get usage(){return this.finalStep.then(a=>a.usage)}get request(){return this.finalStep.then(a=>a.request)}get response(){return this.finalStep.then(a=>a.response)}get totalUsage(){return this.consumeStream(),this._totalUsage.promise}get finishReason(){return this.consumeStream(),this._finishReason.promise}teeStream(){let[a,b]=this.baseStream.tee();return this.baseStream=b,a}get textStream(){return cb(this.teeStream().pipeThrough(new TransformStream({transform({part:a},b){"text-delta"===a.type&&b.enqueue(a.text)}})))}get fullStream(){return cb(this.teeStream().pipeThrough(new TransformStream({transform({part:a},b){b.enqueue(a)}})))}async consumeStream(a){var b;try{await cc({stream:this.fullStream,onError:null==a?void 0:a.onError})}catch(c){null==(b=null==a?void 0:a.onError)||b.call(a,c)}}get experimental_partialOutputStream(){if(null==this.output)throw new ay;return cb(this.teeStream().pipeThrough(new TransformStream({transform({partialOutput:a},b){null!=a&&b.enqueue(a)}})))}toUIMessageStream({originalMessages:a,generateMessageId:b,onFinish:c,messageMetadata:d,sendReasoning:e=!0,sendSources:f=!1,sendStart:g=!0,sendFinish:h=!0,onError:i=C.u1}={}){let j=null!=b?function({originalMessages:a,responseMessageId:b}){if(null==a)return;let c=a[a.length-1];return(null==c?void 0:c.role)==="assistant"?c.id:"function"==typeof b?b():b}({originalMessages:a,responseMessageId:b}):void 0,k={},l=a=>{var b,c;let d=k[a];return(null==(c=null==(b=this.tools)?void 0:b[d])?void 0:c.type)==="dynamic"||void 0};return cb(function({messageId:a,originalMessages:b=[],onFinish:c,onError:d,stream:e}){let f=null==b?void 0:b[b.length-1];(null==f?void 0:f.role)!=="assistant"?f=void 0:a=f.id;let g=!1,h=e.pipeThrough(new TransformStream({transform(b,c){"start"===b.type&&null==b.messageId&&null!=a&&(b.messageId=a),"abort"===b.type&&(g=!0),c.enqueue(b)}}));if(null==c)return h;let i=function({lastMessage:a,messageId:b}){return{message:(null==a?void 0:a.role)==="assistant"?a:{id:b,metadata:void 0,role:"assistant",parts:[]},activeTextParts:{},activeReasoningParts:{},partialToolCalls:{}}}({lastMessage:f?structuredClone(f):void 0,messageId:null!=a?a:""}),j=!1,k=async()=>{if(j||!c)return;j=!0;let a=i.message.id===(null==f?void 0:f.id);await c({isAborted:g,isContinuation:a,responseMessage:i.message,messages:[...a?b.slice(0,-1):b,i.message]})};return(function({stream:a,messageMetadataSchema:b,dataPartSchemas:c,runUpdateMessageJob:d,onError:e,onToolCall:f,onData:g}){return a.pipeThrough(new TransformStream({async transform(a,h){await d(async({state:d,write:i})=>{var j,k,l,m;function n(a){let b=d.message.parts.filter(b9).find(b=>b.toolCallId===a);if(null==b)throw Error("tool-output-error must be preceded by a tool-input-available");return b}function o(a){let b=d.message.parts.filter(a=>"dynamic-tool"===a.type).find(b=>b.toolCallId===a);if(null==b)throw Error("tool-output-error must be preceded by a tool-input-available");return b}function p(a){var b;let c=d.message.parts.find(b=>b9(b)&&b.toolCallId===a.toolCallId);null!=c?(c.state=a.state,c.input=a.input,c.output=a.output,c.errorText=a.errorText,c.rawInput=a.rawInput,c.preliminary=a.preliminary,c.providerExecuted=null!=(b=a.providerExecuted)?b:c.providerExecuted,null!=a.providerMetadata&&"input-available"===c.state&&(c.callProviderMetadata=a.providerMetadata)):d.message.parts.push({type:`tool-${a.toolName}`,toolCallId:a.toolCallId,state:a.state,input:a.input,output:a.output,rawInput:a.rawInput,errorText:a.errorText,providerExecuted:a.providerExecuted,preliminary:a.preliminary,...null!=a.providerMetadata?{callProviderMetadata:a.providerMetadata}:{}})}function q(a){var b;let c=d.message.parts.find(b=>"dynamic-tool"===b.type&&b.toolCallId===a.toolCallId);null!=c?(c.state=a.state,c.toolName=a.toolName,c.input=a.input,c.output=a.output,c.errorText=a.errorText,c.rawInput=null!=(b=a.rawInput)?b:c.rawInput,c.preliminary=a.preliminary,null!=a.providerMetadata&&"input-available"===c.state&&(c.callProviderMetadata=a.providerMetadata)):d.message.parts.push({type:"dynamic-tool",toolName:a.toolName,toolCallId:a.toolCallId,state:a.state,input:a.input,output:a.output,errorText:a.errorText,preliminary:a.preliminary,...null!=a.providerMetadata?{callProviderMetadata:a.providerMetadata}:{}})}async function r(a){if(null!=a){let c=null!=d.message.metadata?function a(b,c){if(void 0===b&&void 0===c)return;if(void 0===b)return c;if(void 0===c)return b;let d={...b};for(let e in c)if(Object.prototype.hasOwnProperty.call(c,e)){let f=c[e];if(void 0===f)continue;let g=e in b?b[e]:void 0,h=null!==f&&"object"==typeof f&&!Array.isArray(f)&&!(f instanceof Date)&&!(f instanceof RegExp),i=null!=g&&"object"==typeof g&&!Array.isArray(g)&&!(g instanceof Date)&&!(g instanceof RegExp);h&&i?d[e]=a(g,f):d[e]=f}return d}(d.message.metadata,a):a;null!=b&&await (0,B.k5)({value:c,schema:b}),d.message.metadata=c}}switch(a.type){case"text-start":{let b={type:"text",text:"",providerMetadata:a.providerMetadata,state:"streaming"};d.activeTextParts[a.id]=b,d.message.parts.push(b),i();break}case"text-delta":{let b=d.activeTextParts[a.id];b.text+=a.delta,b.providerMetadata=null!=(j=a.providerMetadata)?j:b.providerMetadata,i();break}case"text-end":{let b=d.activeTextParts[a.id];b.state="done",b.providerMetadata=null!=(k=a.providerMetadata)?k:b.providerMetadata,delete d.activeTextParts[a.id],i();break}case"reasoning-start":{let b={type:"reasoning",text:"",providerMetadata:a.providerMetadata,state:"streaming"};d.activeReasoningParts[a.id]=b,d.message.parts.push(b),i();break}case"reasoning-delta":{let b=d.activeReasoningParts[a.id];b.text+=a.delta,b.providerMetadata=null!=(l=a.providerMetadata)?l:b.providerMetadata,i();break}case"reasoning-end":{let b=d.activeReasoningParts[a.id];b.providerMetadata=null!=(m=a.providerMetadata)?m:b.providerMetadata,b.state="done",delete d.activeReasoningParts[a.id],i();break}case"file":d.message.parts.push({type:"file",mediaType:a.mediaType,url:a.url}),i();break;case"source-url":d.message.parts.push({type:"source-url",sourceId:a.sourceId,url:a.url,title:a.title,providerMetadata:a.providerMetadata}),i();break;case"source-document":d.message.parts.push({type:"source-document",sourceId:a.sourceId,mediaType:a.mediaType,title:a.title,filename:a.filename,providerMetadata:a.providerMetadata}),i();break;case"tool-input-start":{let b=d.message.parts.filter(b9);d.partialToolCalls[a.toolCallId]={text:"",toolName:a.toolName,index:b.length,dynamic:a.dynamic},a.dynamic?q({toolCallId:a.toolCallId,toolName:a.toolName,state:"input-streaming",input:void 0}):p({toolCallId:a.toolCallId,toolName:a.toolName,state:"input-streaming",input:void 0,providerExecuted:a.providerExecuted}),i();break}case"tool-input-delta":{let b=d.partialToolCalls[a.toolCallId];b.text+=a.inputTextDelta;let{value:c}=await b8(b.text);b.dynamic?q({toolCallId:a.toolCallId,toolName:b.toolName,state:"input-streaming",input:c}):p({toolCallId:a.toolCallId,toolName:b.toolName,state:"input-streaming",input:c}),i();break}case"tool-input-available":a.dynamic?q({toolCallId:a.toolCallId,toolName:a.toolName,state:"input-available",input:a.input,providerMetadata:a.providerMetadata}):p({toolCallId:a.toolCallId,toolName:a.toolName,state:"input-available",input:a.input,providerExecuted:a.providerExecuted,providerMetadata:a.providerMetadata}),i(),f&&!a.providerExecuted&&await f({toolCall:a});break;case"tool-input-error":a.dynamic?q({toolCallId:a.toolCallId,toolName:a.toolName,state:"output-error",input:a.input,errorText:a.errorText,providerMetadata:a.providerMetadata}):p({toolCallId:a.toolCallId,toolName:a.toolName,state:"output-error",input:void 0,rawInput:a.input,errorText:a.errorText,providerExecuted:a.providerExecuted,providerMetadata:a.providerMetadata}),i();break;case"tool-output-available":if(a.dynamic){let b=o(a.toolCallId);q({toolCallId:a.toolCallId,toolName:b.toolName,state:"output-available",input:b.input,output:a.output,preliminary:a.preliminary})}else{let b=n(a.toolCallId);p({toolCallId:a.toolCallId,toolName:ca(b),state:"output-available",input:b.input,output:a.output,providerExecuted:a.providerExecuted,preliminary:a.preliminary})}i();break;case"tool-output-error":if(a.dynamic){let b=o(a.toolCallId);q({toolCallId:a.toolCallId,toolName:b.toolName,state:"output-error",input:b.input,errorText:a.errorText})}else{let b=n(a.toolCallId);p({toolCallId:a.toolCallId,toolName:ca(b),state:"output-error",input:b.input,rawInput:b.rawInput,errorText:a.errorText})}i();break;case"start-step":d.message.parts.push({type:"step-start"});break;case"finish-step":d.activeTextParts={},d.activeReasoningParts={};break;case"start":null!=a.messageId&&(d.message.id=a.messageId),await r(a.messageMetadata),(null!=a.messageId||null!=a.messageMetadata)&&i();break;case"finish":case"message-metadata":await r(a.messageMetadata),null!=a.messageMetadata&&i();break;case"error":null==e||e(Error(a.errorText));break;default:if(a.type.startsWith("data-")){if((null==c?void 0:c[a.type])!=null&&await (0,B.k5)({value:a.data,schema:c[a.type]}),a.transient){null==g||g(a);break}let b=null!=a.id?d.message.parts.find(b=>a.type===b.type&&a.id===b.id):void 0;null!=b?b.data=a.data:d.message.parts.push(a),null==g||g(a),i()}}h.enqueue(a)})}}))})({stream:h,runUpdateMessageJob:async a=>{await a({state:i,write:()=>{}})},onError:d}).pipeThrough(new TransformStream({transform(a,b){b.enqueue(a)},async cancel(){await k()},async flush(){await k()}}))}({stream:this.fullStream.pipeThrough(new TransformStream({transform:async(a,b)=>{let c=null==d?void 0:d({part:a}),m=a.type;switch(m){case"text-start":b.enqueue({type:"text-start",id:a.id,...null!=a.providerMetadata?{providerMetadata:a.providerMetadata}:{}});break;case"text-delta":b.enqueue({type:"text-delta",id:a.id,delta:a.text,...null!=a.providerMetadata?{providerMetadata:a.providerMetadata}:{}});break;case"text-end":b.enqueue({type:"text-end",id:a.id,...null!=a.providerMetadata?{providerMetadata:a.providerMetadata}:{}});break;case"reasoning-start":b.enqueue({type:"reasoning-start",id:a.id,...null!=a.providerMetadata?{providerMetadata:a.providerMetadata}:{}});break;case"reasoning-delta":e&&b.enqueue({type:"reasoning-delta",id:a.id,delta:a.text,...null!=a.providerMetadata?{providerMetadata:a.providerMetadata}:{}});break;case"reasoning-end":b.enqueue({type:"reasoning-end",id:a.id,...null!=a.providerMetadata?{providerMetadata:a.providerMetadata}:{}});break;case"file":b.enqueue({type:"file",mediaType:a.file.mediaType,url:`data:${a.file.mediaType};base64,${a.file.base64}`});break;case"source":f&&"url"===a.sourceType&&b.enqueue({type:"source-url",sourceId:a.id,url:a.url,title:a.title,...null!=a.providerMetadata?{providerMetadata:a.providerMetadata}:{}}),f&&"document"===a.sourceType&&b.enqueue({type:"source-document",sourceId:a.id,mediaType:a.mediaType,title:a.title,filename:a.filename,...null!=a.providerMetadata?{providerMetadata:a.providerMetadata}:{}});break;case"tool-input-start":{k[a.id]=a.toolName;let c=l(a.id);b.enqueue({type:"tool-input-start",toolCallId:a.id,toolName:a.toolName,...null!=a.providerExecuted?{providerExecuted:a.providerExecuted}:{},...null!=c?{dynamic:c}:{}});break}case"tool-input-delta":b.enqueue({type:"tool-input-delta",toolCallId:a.id,inputTextDelta:a.delta});break;case"tool-call":{k[a.toolCallId]=a.toolName;let c=l(a.toolCallId);a.invalid?b.enqueue({type:"tool-input-error",toolCallId:a.toolCallId,toolName:a.toolName,input:a.input,...null!=a.providerExecuted?{providerExecuted:a.providerExecuted}:{},...null!=a.providerMetadata?{providerMetadata:a.providerMetadata}:{},...null!=c?{dynamic:c}:{},errorText:i(a.error)}):b.enqueue({type:"tool-input-available",toolCallId:a.toolCallId,toolName:a.toolName,input:a.input,...null!=a.providerExecuted?{providerExecuted:a.providerExecuted}:{},...null!=a.providerMetadata?{providerMetadata:a.providerMetadata}:{},...null!=c?{dynamic:c}:{}});break}case"tool-result":{let c=l(a.toolCallId);b.enqueue({type:"tool-output-available",toolCallId:a.toolCallId,output:a.output,...null!=a.providerExecuted?{providerExecuted:a.providerExecuted}:{},...null!=a.preliminary?{preliminary:a.preliminary}:{},...null!=c?{dynamic:c}:{}});break}case"tool-error":{let c=l(a.toolCallId);b.enqueue({type:"tool-output-error",toolCallId:a.toolCallId,errorText:i(a.error),...null!=a.providerExecuted?{providerExecuted:a.providerExecuted}:{},...null!=c?{dynamic:c}:{}});break}case"error":b.enqueue({type:"error",errorText:i(a.error)});break;case"start-step":b.enqueue({type:"start-step"});break;case"finish-step":b.enqueue({type:"finish-step"});break;case"start":g&&b.enqueue({type:"start",...null!=c?{messageMetadata:c}:{},...null!=j?{messageId:j}:{}});break;case"finish":h&&b.enqueue({type:"finish",...null!=c?{messageMetadata:c}:{}});break;case"abort":b.enqueue(a);break;case"tool-input-end":case"raw":break;default:throw Error(`Unknown chunk type: ${m}`)}null!=c&&"start"!==m&&"finish"!==m&&b.enqueue({type:"message-metadata",messageMetadata:c})}})),messageId:null!=j?j:null==b?void 0:b(),originalMessages:a,onFinish:c,onError:i}))}pipeUIMessageStreamToResponse(a,{originalMessages:b,generateMessageId:c,onFinish:d,messageMetadata:e,sendReasoning:f,sendSources:g,sendFinish:h,sendStart:i,onError:j,...k}={}){!function({response:a,status:b,statusText:c,headers:d,stream:e,consumeSseStream:f}){let g=e.pipeThrough(new b6);if(f){let[a,b]=g.tee();g=a,f({stream:b})}b5({response:a,status:b,statusText:c,headers:Object.fromEntries(b4(d,b7).entries()),stream:g.pipeThrough(new TextEncoderStream)})}({response:a,stream:this.toUIMessageStream({originalMessages:b,generateMessageId:c,onFinish:d,messageMetadata:e,sendReasoning:f,sendSources:g,sendFinish:h,sendStart:i,onError:j}),...k})}pipeTextStreamToResponse(a,b){!function({response:a,status:b,statusText:c,headers:d,textStream:e}){b5({response:a,status:b,statusText:c,headers:Object.fromEntries(b4(d,{"content-type":"text/plain; charset=utf-8"}).entries()),stream:e.pipeThrough(new TextEncoderStream)})}({response:a,textStream:this.textStream,...b})}toUIMessageStreamResponse({originalMessages:a,generateMessageId:b,onFinish:c,messageMetadata:d,sendReasoning:e,sendSources:f,sendFinish:g,sendStart:h,onError:i,...j}={}){return function({status:a,statusText:b,headers:c,stream:d,consumeSseStream:e}){let f=d.pipeThrough(new b6);if(e){let[a,b]=f.tee();f=a,e({stream:b})}return new Response(f.pipeThrough(new TextEncoderStream),{status:a,statusText:b,headers:b4(c,b7)})}({stream:this.toUIMessageStream({originalMessages:a,generateMessageId:b,onFinish:c,messageMetadata:d,sendReasoning:e,sendSources:f,sendFinish:g,sendStart:h,onError:i}),...j})}toTextStreamResponse(a){return function({status:a,statusText:b,headers:c,textStream:d}){return new Response(d.pipeThrough(new TextEncoderStream),{status:null!=a?a:200,statusText:b,headers:b4(c,{"content-type":"text/plain; charset=utf-8"})})}({textStream:this.textStream,...a})}},cj={type:"no-schema",jsonSchema:void 0,validatePartialResult:async({value:a,textDelta:b})=>({success:!0,value:{partial:a,textDelta:b}}),validateFinalResult:async(a,b)=>void 0===a?{success:!1,error:new aM({message:"No object generated: response did not match schema.",text:b.text,response:b.response,usage:b.usage,finishReason:b.finishReason})}:{success:!0,value:a},createElementStream(){throw new C.b8({functionality:"element streams in no-schema mode"})}};async function ck(a,b,c){let d=await (0,B.N8)({text:a});if(!d.success)throw new aM({message:"No object generated: could not parse the response.",cause:d.error,text:a,response:c.response,usage:c.usage,finishReason:c.finishReason});let e=await b.validateFinalResult(d.value,{text:a,response:c.response,usage:c.usage});if(!e.success)throw new aM({message:"No object generated: response did not match schema.",cause:e.error,text:a,response:c.response,usage:c.usage,finishReason:c.finishReason});return e.value}async function cl(a,b,c,d){try{return await ck(a,b,d)}catch(e){if(null!=c&&aM.isInstance(e)&&(C.u6.isInstance(e.cause)||C.iM.isInstance(e.cause))){let f=await c({text:a,error:e.cause});if(null===f)throw e;return await ck(f,b,d)}throw e}}var cm=(0,B.hK)({prefix:"aiobj",size:24});async function cn(a){let{model:b,output:c="object",system:d,prompt:e,messages:f,maxRetries:g,abortSignal:h,headers:i,experimental_repairText:j,experimental_telemetry:k,experimental_download:l,providerOptions:m,_internal:{generateId:n=cm,currentDate:o=()=>new Date}={},...p}=a,q=bb(b),r="enum"in a?a.enum:void 0,{schema:s,schemaDescription:t,schemaName:u}="schema"in a?a:{};!function({output:a,schema:b,schemaName:c,schemaDescription:d,enumValues:e}){if(null!=a&&"object"!==a&&"array"!==a&&"enum"!==a&&"no-schema"!==a)throw new aE({parameter:"output",value:a,message:"Invalid output type."});if("no-schema"===a){if(null!=b)throw new aE({parameter:"schema",value:b,message:"Schema is not supported for no-schema output."});if(null!=d)throw new aE({parameter:"schemaDescription",value:d,message:"Schema description is not supported for no-schema output."});if(null!=c)throw new aE({parameter:"schemaName",value:c,message:"Schema name is not supported for no-schema output."});if(null!=e)throw new aE({parameter:"enumValues",value:e,message:"Enum values are not supported for no-schema output."})}if("object"===a){if(null==b)throw new aE({parameter:"schema",value:b,message:"Schema is required for object output."});if(null!=e)throw new aE({parameter:"enumValues",value:e,message:"Enum values are not supported for object output."})}if("array"===a){if(null==b)throw new aE({parameter:"schema",value:b,message:"Element schema is required for array output."});if(null!=e)throw new aE({parameter:"enumValues",value:e,message:"Enum values are not supported for array output."})}if("enum"===a){if(null!=b)throw new aE({parameter:"schema",value:b,message:"Schema is not supported for enum output."});if(null!=d)throw new aE({parameter:"schemaDescription",value:d,message:"Schema description is not supported for enum output."});if(null!=c)throw new aE({parameter:"schemaName",value:c,message:"Schema name is not supported for enum output."});if(null==e)throw new aE({parameter:"enumValues",value:e,message:"Enum values are required for enum output."});for(let a of e)if("string"!=typeof a)throw new aE({parameter:"enumValues",value:a,message:"Enum values must be strings."})}}({output:c,schema:s,schemaName:u,schemaDescription:t,enumValues:r});let{maxRetries:v,retry:w}=bP({maxRetries:g,abortSignal:h}),x=function({output:a,schema:b,enumValues:c}){switch(a){case"object":let d;return{type:"object",jsonSchema:(d=(0,B.mD)(b)).jsonSchema,validatePartialResult:async({value:a,textDelta:b})=>({success:!0,value:{partial:a,textDelta:b}}),validateFinalResult:async a=>(0,B.ZZ)({value:a,schema:d}),createElementStream(){throw new C.b8({functionality:"element streams in object mode"})}};case"array":var e=(0,B.mD)(b);let{$schema:f,...g}=e.jsonSchema;return{type:"enum",jsonSchema:{$schema:"http://json-schema.org/draft-07/schema#",type:"object",properties:{elements:{type:"array",items:g}},required:["elements"],additionalProperties:!1},async validatePartialResult({value:a,latestObject:b,isFirstDelta:c,isFinalDelta:d}){var f;if(!(0,C.k9)(a)||!(0,C.cj)(a.elements))return{success:!1,error:new C.iM({value:a,cause:"value must be an object that contains an array of elements"})};let g=a.elements,h=[];for(let a=0;a<g.length;a++){let b=g[a],c=await (0,B.ZZ)({value:b,schema:e});if(a!==g.length-1||d){if(!c.success)return c;h.push(c.value)}}let i=null!=(f=null==b?void 0:b.length)?f:0,j="";return c&&(j+="["),i>0&&(j+=","),j+=h.slice(i).map(a=>JSON.stringify(a)).join(","),d&&(j+="]"),{success:!0,value:{partial:h,textDelta:j}}},async validateFinalResult(a){if(!(0,C.k9)(a)||!(0,C.cj)(a.elements))return{success:!1,error:new C.iM({value:a,cause:"value must be an object that contains an array of elements"})};let b=a.elements;for(let a of b){let b=await (0,B.ZZ)({value:a,schema:e});if(!b.success)return b}return{success:!0,value:b}},createElementStream(a){let b=0;return cb(a.pipeThrough(new TransformStream({transform(a,c){switch(a.type){case"object":{let d=a.object;for(;b<d.length;b++)c.enqueue(d[b]);break}case"text-delta":case"finish":case"error":break;default:throw Error(`Unsupported chunk type: ${a}`)}}})))}};case"enum":return{type:"enum",jsonSchema:{$schema:"http://json-schema.org/draft-07/schema#",type:"object",properties:{result:{type:"string",enum:c}},required:["result"],additionalProperties:!1},async validateFinalResult(a){if(!(0,C.k9)(a)||"string"!=typeof a.result)return{success:!1,error:new C.iM({value:a,cause:'value must be an object that contains a string in the "result" property.'})};let b=a.result;return c.includes(b)?{success:!0,value:b}:{success:!1,error:new C.iM({value:a,cause:"value must be a string in the enum"})}},async validatePartialResult({value:a,textDelta:b}){if(!(0,C.k9)(a)||"string"!=typeof a.result)return{success:!1,error:new C.iM({value:a,cause:'value must be an object that contains a string in the "result" property.'})};let d=a.result,e=c.filter(a=>a.startsWith(d));return 0===a.result.length||0===e.length?{success:!1,error:new C.iM({value:a,cause:"value must be a string in the enum"})}:{success:!0,value:{partial:e.length>1?d:e[0],textDelta:b}}},createElementStream(){throw new C.b8({functionality:"element streams in enum mode"})}};case"no-schema":return cj;default:throw Error(`Unsupported output: ${a}`)}}({output:c,schema:s,enumValues:r}),y=bj(p),z=(0,B.WZ)(null!=i?i:{},`ai/${bd}`),A=bC({model:q,telemetry:k,headers:z,settings:{...y,maxRetries:v}}),D=bG(k);try{return await bH({name:"ai.generateObject",attributes:bJ({telemetry:k,attributes:{...bB({operationId:"ai.generateObject",telemetry:k}),...A,"ai.prompt":{input:()=>JSON.stringify({system:d,prompt:e,messages:f})},"ai.schema":null!=x.jsonSchema?{input:()=>JSON.stringify(x.jsonSchema)}:void 0,"ai.schema.name":u,"ai.schema.description":t,"ai.settings.output":x.type}}),tracer:D,fn:async a=>{var b;let c,g,i,r,s,v,B,C,E=await bz({system:d,prompt:e,messages:f}),F=await bh({prompt:E,supportedUrls:await q.supportedUrls,download:l}),G=await w(()=>bH({name:"ai.generateObject.doGenerate",attributes:bJ({telemetry:k,attributes:{...bB({operationId:"ai.generateObject.doGenerate",telemetry:k}),...A,"ai.prompt.messages":{input:()=>bK(F)},"gen_ai.system":q.provider,"gen_ai.request.model":q.modelId,"gen_ai.request.frequency_penalty":y.frequencyPenalty,"gen_ai.request.max_tokens":y.maxOutputTokens,"gen_ai.request.presence_penalty":y.presencePenalty,"gen_ai.request.temperature":y.temperature,"gen_ai.request.top_k":y.topK,"gen_ai.request.top_p":y.topP}}),tracer:D,fn:async a=>{var b,c,d,e,f,g,i,j;let l=await q.doGenerate({responseFormat:{type:"json",schema:x.jsonSchema,name:u,description:t},...bj(p),prompt:F,providerOptions:m,abortSignal:h,headers:z}),r={id:null!=(c=null==(b=l.response)?void 0:b.id)?c:n(),timestamp:null!=(e=null==(d=l.response)?void 0:d.timestamp)?e:o(),modelId:null!=(g=null==(f=l.response)?void 0:f.modelId)?g:q.modelId,headers:null==(i=l.response)?void 0:i.headers,body:null==(j=l.response)?void 0:j.body},s=bQ(l.content),v=function(a){let b=a.filter(a=>"reasoning"===a.type);return 0===b.length?void 0:b.map(a=>a.text).join("\n")}(l.content);if(void 0===s)throw new aM({message:"No object generated: the model did not return a response.",response:r,usage:l.usage,finishReason:l.finishReason});return a.setAttributes(bJ({telemetry:k,attributes:{"ai.response.finishReason":l.finishReason,"ai.response.object":{output:()=>s},"ai.response.id":r.id,"ai.response.model":r.modelId,"ai.response.timestamp":r.timestamp.toISOString(),"ai.response.providerMetadata":JSON.stringify(l.providerMetadata),"ai.usage.promptTokens":l.usage.inputTokens,"ai.usage.completionTokens":l.usage.outputTokens,"gen_ai.response.finish_reasons":[l.finishReason],"gen_ai.response.id":r.id,"gen_ai.response.model":r.modelId,"gen_ai.usage.input_tokens":l.usage.inputTokens,"gen_ai.usage.output_tokens":l.usage.outputTokens}})),{...l,objectText:s,reasoning:v,responseData:r}}}));c=G.objectText,g=G.finishReason,i=G.usage,r=G.warnings,B=G.providerMetadata,v=null!=(b=G.request)?b:{},s=G.responseData,C=G.reasoning,aA(r);let H=await cl(c,x,j,{response:s,usage:i,finishReason:g});return a.setAttributes(bJ({telemetry:k,attributes:{"ai.response.finishReason":g,"ai.response.object":{output:()=>JSON.stringify(H)},"ai.response.providerMetadata":JSON.stringify(B),"ai.usage.promptTokens":i.inputTokens,"ai.usage.completionTokens":i.outputTokens}})),new co({object:H,reasoning:C,finishReason:g,usage:i,warnings:r,request:v,response:s,providerMetadata:B})}})}catch(a){throw bA(a)}}var co=class{constructor(a){this.object=a.object,this.finishReason=a.finishReason,this.usage=a.usage,this.warnings=a.warnings,this.providerMetadata=a.providerMetadata,this.response=a.response,this.request=a.request,this.reasoning=a.reasoning}toJsonResponse(a){var b;return new Response(JSON.stringify(this.object),{status:null!=(b=null==a?void 0:a.status)?b:200,headers:b4(null==a?void 0:a.headers,{"content-type":"application/json; charset=utf-8"})})}};(0,B.hK)({prefix:"aiobj",size:24}),C.bD,((a,b)=>{for(var c in b)au(a,c,{get:b[c],enumerable:!0})})({},{object:()=>cq,text:()=>cp});var cp=()=>({type:"text",responseFormat:{type:"text"},parsePartial:async({text:a})=>({partial:a}),parseOutput:async({text:a})=>a}),cq=({schema:a})=>{let b=(0,B.mD)(a);return{type:"object",responseFormat:{type:"json",schema:b.jsonSchema},async parsePartial({text:a}){let b=await b8(a);switch(b.state){case"failed-parse":case"undefined-input":return;case"repaired-parse":case"successful-parse":return{partial:b.value};default:{let a=b.state;throw Error(`Unsupported parse state: ${a}`)}}},async parseOutput({text:a},c){let d=await (0,B.N8)({text:a});if(!d.success)throw new aM({message:"No object generated: could not parse the response.",cause:d.error,text:a,response:c.response,usage:c.usage,finishReason:c.finishReason});let e=await (0,B.ZZ)({value:d.value,schema:b});if(!e.success)throw new aM({message:"No object generated: response did not match schema.",cause:e.error,text:a,response:c.response,usage:c.usage,finishReason:c.finishReason});return e.value}}},cr=Symbol.for("vercel.ai.error.AI_NoSuchProviderError");C.eM;var cs=D._H({name:D.Yj(),version:D.Yj()}),ct=D._H({_meta:D.lq(D.Ik({}).loose())}),cu=D.Ik({method:D.Yj(),params:D.lq(ct)}),cv=D._H({experimental:D.lq(D.Ik({}).loose()),logging:D.lq(D.Ik({}).loose()),prompts:D.lq(D._H({listChanged:D.lq(D.zM())})),resources:D.lq(D._H({subscribe:D.lq(D.zM()),listChanged:D.lq(D.zM())})),tools:D.lq(D._H({listChanged:D.lq(D.zM())}))});ct.extend({protocolVersion:D.Yj(),capabilities:cv,serverInfo:cs,instructions:D.lq(D.Yj())});var cw=ct.extend({nextCursor:D.lq(D.Yj())}),cx=D.Ik({name:D.Yj(),description:D.lq(D.Yj()),inputSchema:D.Ik({type:D.eu("object"),properties:D.lq(D.Ik({}).loose())}).loose()}).loose();cw.extend({tools:D.YO(cx)});var cy=D.Ik({type:D.eu("text"),text:D.Yj()}).loose(),cz=D.Ik({type:D.eu("image"),data:D.K3(),mimeType:D.Yj()}).loose(),cA=D.Ik({uri:D.Yj(),mimeType:D.lq(D.Yj())}).loose(),cB=cA.extend({text:D.Yj()}),cC=cA.extend({blob:D.K3()}),cD=D.Ik({type:D.eu("resource"),resource:D.KC([cB,cC])}).loose();ct.extend({content:D.YO(D.KC([cy,cz,cD])),isError:D.zM().default(!1).optional()}).or(ct.extend({toolResult:D.L5()}));var cE=D.Ik({jsonrpc:D.eu("2.0"),id:D.KC([D.Yj(),D.ai().int()])}).merge(cu).strict(),cF=D.Ik({jsonrpc:D.eu("2.0"),id:D.KC([D.Yj(),D.ai().int()]),result:ct}).strict(),cG=D.Ik({jsonrpc:D.eu("2.0"),id:D.KC([D.Yj(),D.ai().int()]),error:D.Ik({code:D.ai().int(),message:D.Yj(),data:D.lq(D.L5())})}).strict(),cH=D.Ik({jsonrpc:D.eu("2.0")}).merge(D.Ik({method:D.Yj(),params:D.lq(ct)})).strict();D.KC([cE,cH,cF,cG]),C.bD;var cI=D.Ik({type:D.eu("text"),text:D.Yj(),state:D.k5(["streaming","done"]).optional(),providerMetadata:bm.optional()}),cJ=D.Ik({type:D.eu("reasoning"),text:D.Yj(),state:D.k5(["streaming","done"]).optional(),providerMetadata:bm.optional()}),cK=D.Ik({type:D.eu("source-url"),sourceId:D.Yj(),url:D.Yj(),title:D.Yj().optional(),providerMetadata:bm.optional()}),cL=D.Ik({type:D.eu("source-document"),sourceId:D.Yj(),mediaType:D.Yj(),title:D.Yj(),filename:D.Yj().optional(),providerMetadata:bm.optional()}),cM=D.Ik({type:D.eu("file"),mediaType:D.Yj(),filename:D.Yj().optional(),url:D.Yj(),providerMetadata:bm.optional()}),cN=D.Ik({type:D.eu("step-start")}),cO=D.Ik({type:D.Yj().startsWith("data-"),id:D.Yj().optional(),data:D.L5()}),cP=[D.Ik({type:D.eu("dynamic-tool"),toolName:D.Yj(),toolCallId:D.Yj(),state:D.eu("input-streaming"),input:D.L5().optional(),output:D.Zm().optional(),errorText:D.Zm().optional()}),D.Ik({type:D.eu("dynamic-tool"),toolName:D.Yj(),toolCallId:D.Yj(),state:D.eu("input-available"),input:D.L5(),output:D.Zm().optional(),errorText:D.Zm().optional(),callProviderMetadata:bm.optional()}),D.Ik({type:D.eu("dynamic-tool"),toolName:D.Yj(),toolCallId:D.Yj(),state:D.eu("output-available"),input:D.L5(),output:D.L5(),errorText:D.Zm().optional(),callProviderMetadata:bm.optional(),preliminary:D.zM().optional()}),D.Ik({type:D.eu("dynamic-tool"),toolName:D.Yj(),toolCallId:D.Yj(),state:D.eu("output-error"),input:D.L5(),output:D.Zm().optional(),errorText:D.Yj(),callProviderMetadata:bm.optional()})],cQ=[D.Ik({type:D.Yj().startsWith("tool-"),toolCallId:D.Yj(),state:D.eu("input-streaming"),providerExecuted:D.zM().optional(),input:D.L5().optional(),output:D.Zm().optional(),errorText:D.Zm().optional()}),D.Ik({type:D.Yj().startsWith("tool-"),toolCallId:D.Yj(),state:D.eu("input-available"),providerExecuted:D.zM().optional(),input:D.L5(),output:D.Zm().optional(),errorText:D.Zm().optional(),callProviderMetadata:bm.optional()}),D.Ik({type:D.Yj().startsWith("tool-"),toolCallId:D.Yj(),state:D.eu("output-available"),providerExecuted:D.zM().optional(),input:D.L5(),output:D.L5(),errorText:D.Zm().optional(),callProviderMetadata:bm.optional(),preliminary:D.zM().optional()}),D.Ik({type:D.Yj().startsWith("tool-"),toolCallId:D.Yj(),state:D.eu("output-error"),providerExecuted:D.zM().optional(),input:D.L5(),output:D.Zm().optional(),errorText:D.Yj(),callProviderMetadata:bm.optional()})];D.Ik({id:D.Yj(),role:D.k5(["system","user","assistant"]),metadata:D.L5().optional(),parts:D.YO(D.KC([cI,cJ,cK,cL,cM,cN,cO,...cP,...cQ]))})}};